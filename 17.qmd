---
date-modified: last-modified
number-sections: true
format: 
  html: 
    toc: true
code-link: true
code-copy: true
execute: 
  warning: false
  error: false
  freeze: auto
editor: visual
---

# 공간계량경제학적 모형 {#sec-econometrics}

전형적인 형태의 공간적 자기회귀모형(spatial autoregressive model)은 공간 가중치 행렬을 이용하고 최대우도추정법(MLE, maximum likelihood estimation)을 적용하는 방식으로 이미 오래전에 정식화되었다(Cliff and Ord 1973, 1981). 이후 이러한 초기 연구가 확장되면서, 공간계량경제학적 관점에서 다앙한 모형이 발전해 왔으며, 이들 중 상당수는 동시적 자기회귀(simultaneous autoregressive) 프레임워크와 행 표준화 공간 가중치 행렬을 사용하였다(Anselin 1988). 동시적 자기회귀 프레임워크와 조건부 자기회귀(conditional autoregressive) 프레임워크가 양대 축을 이루며, 두 프레임워크 모두에서 관측치의 상대적 중요성을 반영하기 위해 사례 가중치를 보완적으로 활용할 수 있다(Waller and Gotway 2004).

공간회귀모형의 적합 과정에서 제기되는 여러 문제를 논의하기에 앞서, 몇 가지 사항을 먼저 언급한다. 공간적 회귀분석을 공간계량경제학적 맥락에서 접근하는 방법에 대한 최근은 종합적 검토는 Kelejian과 Piras(2017)가 제공하였다. 이 연구에서는 '반응 변수의 공간래그(spatially lagged response variable)'의 계수를 $\lambda$, '잔차의 공간래그'의 계수를 $\rho$로 표기하는데, 이는 Anselin(1988)과 LeSage와 Pace(2009) 등 기존 문헌과는 반대이다. 본 장에서는 혼동을 피하기 위해, 공간래그모형(SLM, spatial lag model)의 공간 계수는 $\rho_\text {Lag}$, 공간오차모형(SEM, spatial error model)의 공간 계수는 $\rho_\text{Err}$로 표기한다. 주목할 만한 발견 중 하나는, 상대적으로 조밀한 공간 가중치 행렬이 모형 추정치를 과소평가할 수 있다는 점이며, 이는 희소 가중치 행렬이 더 적합할 수 있음을 시사한다(Smith 2009). 또 다른 중요한 발견은, 잔차에 공간적 자기상관이 존재하더라도, 공변량 자체가 공간적 자기상관을 보이지 않는 한, 회귀계수 분산의 추정치는 편향되지 않는다는 점이다(Smith and Lee 2012). 그러나 실제로는 반응변수와 공변량의 공간적 프로세스가 일치하지 않는 경우가 많으며, 공변량과 잔차가 모두 공간적 자기상관을 보이는 경우, 공간 프로세스를 모형화하지 않으면 회귀계수 분산의 추정치가 과소평가될 가능성이 높다.

## 정의

공간 프로세스를 모형화하려는 시도 가운데 가장 초기의 공간계량경제학적 정식화 중 하나는, 잔차의 공간적 자기상관을 모형화하는 방식이다. 이는 공간오차모형(SEM)으로 다음과 같이 표현된다.

$$
\textbf{y}=\textbf{X}\beta+\textbf{u},\qquad \textbf{u}=\rho_\text {Err} \textbf{Wu}+\epsilon,
$$

여기서 $\textbf{y}$는 $N$ 위치에서 측정된 반응변수의 $(N\times1)$ 관측치 벡터, $\textbf{X}$는 $(N \times k)$ 공변량 행렬, $\beta$는 $(k \times 1)$ 계수 벡터, $\textbf{u}$는 공간적 자기상관을 갖는 $(N \times 1)$ 교란 벡터, $\epsilon$은 독립항등분포를 따르는 $(N \times 1)$ 교란 벡터, $\rho_\text{Err}$는 스칼라 형태의 공간 계수이다.

이 모형과 유사한 다른 공간계량경제학 모형들은 혼합모형 프레임워크에는 부합하지 않는다. 여기서 모형화된 공간 프로세스는 반응변수, 공변량, 그리고 계수와 직접적으로 상호작용한다. 이러한 형태의 모형화 접근은 시계열 프레임워크를 단순히 2차원으로 확장한 오래된 전통에서 기원한 것으로 보인다.

$$
\textbf{u}=(\textbf{I}-\rho_\text{Err}\textbf{W})^{-1}\epsilon,\quad \textbf{y}=\textbf{X}\beta+(\textbf{I}-\rho_\text{Err}\textbf{W})^{-1}\epsilon,\quad (\textbf{I}-\rho_\text{Err}\textbf{W})\textbf{y}=(\textbf{I}-\rho_\text{Err}\textbf{W})\textbf{X}\beta+\epsilon.
$$

만약 공변량과 반응변수가 동일한 공간 프로세스를 따른다면, 최소제곱법(OLS) 계수와 공간오차모형 계수 사이의 차이는 거의 없을 것이다. 그러나 실제로는 두 프로세스가 일치하지 않는 경우가 많으며, 이를 판별 및 조정하기 위해서는 Hausman 검정과 같은 추가 절차가 필요하다(Pace and LeSage 2008). 이러한 논의는, 공간 프로세스가 일치하는 경우 시계열 분석의 단위근(unit root)과 공적분(cointegration) 개념을 공간적으로 확장하려는 이전 연구와도 연결된다(Fingleton 1999).

반응변수에만 공간 프로세스를 포함하는 모형을 공간래그모형(SLM)이라 하며, 종종 공간적 자기회귀모형(SAR, spatial autoregressive mode)이라고도 부른다(LeSage and Pace 2009). 더빈(Durbin) 모형은 여기에 공변량의 공간래그항을 추가한 형태이다. 공간 더빈 모형에 관한 종합적인 리뷰는 Mur와 Angulo(2006)를 참고할 수 있다. 만약 반응변수에 공간 프로세스를 포함하는 동시에 잔차에도 공간 프로세스를 포함시키면, 두 가지 형태의 모형이 가능하다. 하나는 모든 모형 요소를 포함하는 일반중첩모형(GNM, general nested model)이고, 다른 하나는 공간래그 공변량을 포함하지 않는 공간자기회귀-자기회귀모형(SARAR, spatial autoregressive-autoregressive model) 또는 공간자기회귀결합모형(SAC, spatial autoregressive combined model)이다. 반면, 반응변수나 잔차에 공간 프로세스를 모형화하지 않고, 단순히 공변량의 공간래그항을 선형모형에 추가할 수도 있다. 이를 공간래그X모형(SLX, spatial lag of X model)이라고 한다(Elhorst 2010; Bivand 2012; LeSage 2014; Halleck Vega and Elhorst 2015). GNM은 다음과 같이 표현된다.

$$
\textbf{y}=\rho_\text{Lag}\textbf{Wy}+\textbf{X}\beta+\textbf{WX}\gamma+\textbf{u},\qquad \textbf{u}=\rho_\text{Err}\textbf{Wu}+\epsilon
$$

여기서 $\gamma$는 $(k' \times 1)$ 파라미터 벡터이다. $k'$는 절편과 일부 공변량을 정의하며, 행 표준화 공간 가중치 행렬을 사용하고 공간래그 절편을 포함하지 않는 경우 $k'=k-1$이다.

이 기본 모형에 특정 제약을 가하면 다양한 변형 모형이 도출된다. $\gamma = 0$으로 설정하면 이중 공간계수 모형인 SAC/SARAR 모형이 되며, $\rho_\text{Lag}=0$으로 설정하면 오차더빈모형(SDEM, spatial Durbin error model)이 된다. 더 강한 조건을 부여할 수도 있는데, $\gamma = 0$과 $\rho_\text{Err}=0$로 설정하면 공간래그모형(SLM), $\gamma=0$와 $\rho_\text{Lag}=0$으로 설정하며 공간오차모형(SEM), $\rho_\text{Lag}=0$과 $\rho_\text{Err}=0$으로 설정하면 공간래그X모형(SLX)이 된다.

공변량이 관측된 새로운 위치에 대해 예측을 수행하는 것과 관련된 문제는 오래전부터 인식되어 왔지만, 그 가능성에 대한 체계적인 검토와 실질적 진전은 상당한 시간이 지나서야 이루어졌다(Bivand 2002; Goulard, Laurent, and Thomas-Agnan 2017; Laurent and Margaretic 2021). MLE로 적합된 SLM, SDM, SEM, SDEM, SAC, GNM 모형을 예측에 적용하는 방법은 'Google Summer of Code(구글 썸머 오프 코드)' 프로젝트를 수행한 마틴 구브리(Martin Gubri)의 공로가 크다. 또한, 결측 데이터를 다루는 유사한 모형에 관한 연구(Suesse 2018)는 보스턴 주택 데이터셋에서 검열된 중앙값 주택가격을 분석하는데 시사점을 제공한다. 예측 문제를 다루다 보면 해당 모형의 축약 형태(reduced form)가 매우 중요하다는 점을 인식하게 된다. 특히 SLM, SDM, SAC, GNM 모형처럼 반응변수의 공간 프로세스가 회귀계수와 상호작용하는 경우에는, 보다 단순화된 형태의 표현이 분석과 해석에 도움이 될 수 있다.(역자주: 여기서 ‘축약 형태’란 공간계량경제학이나 회귀분석에서 모형을 단순화하여, 반응변수를 설명변수와 오차항만의 함수로 나타낸 식을 말하며, 효과 계산과 예측 분석에서 핵심적인 역할을 한다. 예를 들어 SLM에서는 단위행렬에서 공간계수와 공간 가중치 행렬의 곱을 뺀 행렬의 역행렬을 곱해 풀면 축약 형태가 되며, 이 역행렬이 공간 파급 효과를 나타낸다.)

반응변수와 회귀계수 간 이러한 상호작용의 결과, 공변량의 단위 변화가 회귀계수 값에 비례하여 반응변수에 직접 효과를 미치려면, 공간래그 반응변수의 계수가 0이어야 한다. 만약 공간 계수가 0이 아니라면, 전역적 파급효과가 작용하게 되며, 그 크기는 회귀계수 만큼이나 중요한 정보가 된다(LeSage and Pace 2009; Elhorst 2010; Bivand 2012; LeSage 2014; Halleck Vega and Elhorst 2015). SDEM 및 SLX 모형의 경우, 각 공변량의 총 파급효과(total spillover effect)는 해당 공변량의 계수와 공간래그 공변량 계수의 합으로 정의되며, 국지적 파급효과(local spillover effect)는 이를 기반으로 선형결합을 사용해 표준오차를 계산하여 나타낸다.

이것은 GNM 데이터 생성 프로세스에서 확인할 수 있다.

$$
(\textbf{I}-\rho_{\text Err}\textbf{W})(\textbf{I}-\rho_{\text Lag}\textbf{W})\textbf{y}=(\textbf{I}-\rho_{\text Err}\textbf{W})(\textbf{X}\beta+\textbf{WX}\gamma)+\epsilon
$$

이를 다음과 같이 변형하여 나타낼 수 있다.

$$
\textbf{y}=(\textbf{I}-\rho_\text{Lag}\textbf{W})^{-1}(\textbf{X}\beta+\textbf{WX}\gamma)+(\textbf{I}-\rho_\text{Lag}\textbf{W})^{-1}(\textbf{I}-\rho_\text{Err}\textbf{W})^{-1}\epsilon.
$$

이 식에서 $\rho_\text{Lag}$와 $\beta$ 사이에는 상호작용이 존재하며, $\gamma$가 존재할 경우에는 세 변수 간의 상호작용이 발생한다. 이는 다음의 편도함수에서 확인할 수 있다: $\partial y_i/\partial x_{jr}=((\textbf{I}-\rho_\text{Lag}\textbf{W})^{-1}(\textbf{I}\beta_r+\textbf{W}\gamma_r))_{ij}$. 여기서 밀집 행렬 $S_r(\textbf{W})=((\textbf{I}-\rho_\text{Lag}\textbf{W})^{-1}(\textbf{I}\beta_r+\textbf{W}\gamma_r))$의 주대각 요소는 직접 효과(direct effect)을 나타내고, 비대각 요소는 간접 효과(indirect effect)를 나타낸다.

Piras와 Prucha(2014)는 Raymond J. G. M. Florax, Folmer, Rey(2003)를 재검토하고 수정하였으며, Hendry(2006)와 Raymond J. G. M. Florax, Folmer, Rey(2006)의 논평도 참고하였다. 이들은 모형 선택 시 통상적으로 사용되는 사전 검정(pre-test) 전략보다, 해당 분석 상황에 적합한 가장 일반적인 모형을 먼저 추정하는 전략이 더 바람직하다고 결론지었다.(역자주: 여기서 '사전 검정 전략'이란 모형을 선택하기 전에 잔차의 공간적 자기상관 등 사전 가설검정을 수행하고, 그 결과에 따라 SLM, SEM 등 최종 모형을 결정하는 방법을 말한다. 그러나 표본 의존성과 모형 누락 위험이 있어, Piras와 Prucha(2014)는 가장 일반적인 모형을 먼저 적합한 뒤 필요시 단순화하는 방식을 권고하였다.) 이러한 결과에 비추어, 본 장에서는 사전 검정 기반의 모형 선택은 사용하지 않는다.

현재 **spatialreg** 패키지가 주력하고 있는 개선 사항 중 하나는 공간래그 공변량 처리 방법의 향상이다. 이를 위해 `Durbin` 인수를 사용하여, 공간래그 형태로 추가할 공변량의 하위 집합을 지정하는 논리값이나 수식을 받을 수 있도록 하였다. 일부 공변량, 예를 들어 더미 변수와 같은 경우에는 공간래그 형태로 포함하지 않는 것이 바람직하다는 주장도 있다. 공간래그 공변량이 선택되면, 다음 과제는 영향력을 계산할 때 이를 어떻게 적절하게 처리할 것인가 하는 문제이다. 이러한 개선된 기능은 MCMC 또는 MLE로 적합된 횡단면 모형에 적용되며, 향후 공간 패널 모형에도 적용될 예정이다.

거의 다루어지지 않은 주제이지만, 기능적 형태 가정(functional form assumption)을 언급할 가치가 있다.(역자주: 여기서 '기능적 형태 가정'이란 반응변수와 독립변수 간의 관계가 특정한 수학적 형태(예: 선형, 로그-선형, 다항식)를 따른다고 전제하는 것이다. 이러한 가정이 실제 데이터 생성 프로세스를 잘 반영하지 못하면 추정 결과에 편향이 발생할 수 있다. 공간계량경제학에서는 반응변수, 공간 효과, 공변량 간 관계를 특정 형태로 가정하는 경우가 많으며, 이러한 한계를 보완하기 위해 공간 분위수 회귀 등 보다 유연한 모형이 활용되기도 한다.) 이 문제는, 예를 들어 **McSpatial** 패키지에서 구현된 공간 분위수 회귀(spatial quatile regression, McMillen 2013)와 같은 유연한 구조가 유용한 상황과 관련이 있다. 또한 **McSpatial** 패키지의 일부 함수, 신규 패키지 **spldv**(Sarrias and Piras 2022), 그리고 **spatialprobit** 패키지와 **ProbitSpatial** 패키지(Wilhelm and Matos 2013; Martinetti and Geniaux 2017)에서 다루는 이산형 반응변수 관련 문제도 있다. **McSpatial** 패키지의 MCMC 구현은 LeSage와 Pace(2009)에 기반하고 있다. 마지막으로, Wagner와 Zeileis(2019)는 SLM 모형이 재귀적 분할(recursive partitioning) 설정에서 어떻게 활용될 수 있는지를 보여주며, 이를 **spatialreg** 패키지의 `lagsarlm()` 함수를 이용해 구현하는 **lagsarlmtree** 패키지에서 제시하였다.

**spatialreg** 패키지(Bivand and Piras 2022)를 이용한 횡단면(cross-sectional) MLE와 일반화 모멘트법(GMM, generalised method of moments) 추정, 그리고 **sphet** 패키지를 통해 공간계량경제학 스타일의 공간 회귀모형에 대한 리뷰(Bivand and Piras 2015)는 여전히 대부분 유효하다. 이 리뷰에서는 R 패키지에서 제공하는 추정량을 다른 프로그래밍 언어의 대체 구현과 비교하였으나, 베이지안 공간계량경제학 스타일의 공간 회귀는 다루지 않았다. Millo와 Piras(2012)가 설명한 공간 패널 추정량에 대해서는 많은 변화가 있었지만, 본 장에서는 다루지 않는다.

Bivand, Millo와 Piras(2021)는 공간계량경제학적 분석을 위한 R 패키지의 다양한 기능을 포괄적으로 다루며, Bivand와 Piras(2015)를 업데이트하고 GMM 및 공간 패널 모형화의 최근 발전을 포함하고 있다. 따라서 이 장에서는 보스턴 주택가격 데이터셋을 사용한 Bivand(2017)의 예제 중 일부만을 간략히 다룰 것이다.

## 최대우도추정법: spatialreg 패키지의 활용

단일 공간계수를 가지는 모형(SEM 및 SDEM은 `errorsarlm()` 함수 사용, SLM 및 SDM은 `lagsarlm()` 함수 사용)에는 Ord(1975)가 처음 제시한 방법이 적용된다. 다음 표는 최대우도추정법(MLE)을 사용하여 앞서 설명한 모형을 추정할 수 있는 함수를 정리한 것이다.

| 모형 | 모형명           | MLE 함수                        |
|------|------------------|---------------------------------|
| SEM  | 공간오차         | `errorsarlm(..., Durbin=FALSE)` |
| SEM  | 공간오차         | `spautolm(..., family="SAR")`   |
| SDEM | 공간더빈오차     | `errorsarlm(..., Durbin=TRUE)`  |
| SLM  | 공간래그         | `lagsarlm(..., Durbin=FALSE)`   |
| SDM  | 공간더빈         | `lagsarlm(..., Durbin=TRUE)`    |
| SAC  | 공간자기회귀결합 | `sacsarlm(..., Durbin=FALSE)`   |
| GNM  | 일반중첩         | `sacsarlm(..., Durbin=TRUE)`    |

`errorsarlm()`과 `lagsarlm()` 추정 함수는 유사한 인수를 받는다. 첫 번째(`formula`)와 두 번째(`data`) 인수는 대부분의 모형 추정 함수에서 공통적으로 사용되며, 세 번째 인수는 `listw` 공간 가중치 객체이다. `na.action` 인수는 결측값이 있는 관측 개체의 공간 가중치를 어떻게 처리할지를 정의하며, 다른 모형 추정 함수와 동일하게 동작한다. `weights` 인수는 분산 항에서 관측값별 변동성을 나타내는 가중치를 제공하는 데 사용되지만, `lagsarlm()` 함수에서는 이 옵션이 제공되지 않는다.

`Durbin` 인수는 이전의 `type` 및 `etype` 인수를 대체하며, 지정하지 않으면 기본값은 `FALSE`로 간주된다. 지정하는 경우, `FALSE` 또는 `TRUE` 값을 줄 수 있는데, `TRUE`로 설정하면 모든 공간래그 설명변수가 포함된다. 또는 포함할 공간래그 설명변수를 지저하는 일면 공식(one-sided formula)을 줄 수 있다.(역자주: 여기서 '일면 공식'이란 R에서 좌변 없이 `~ 변수1 + 변수2` 형태로 작성된 공식을 말하며, 주로 변수 집합을 지정할 때 사용된다. 여기서는 공간래그로 포함할 설명변수를 선택하는 데 쓰인다.) `method` 인수는 로그우도 함수에서 로그 행렬식 항을 계산하는 방법을 지정하며, 기본값 `"eigen"`은 중간 규모의 데이터셋에 적합하다. `interval` 인수는 **stats** 패키지의 `optimize()` 함수를 통해 공간계수를 탐색하는 범위를 지정한다. `tol.solve()` 인수는 **base** 패키지의 `solve()` 함수에 전달되며, 회귀계수 간 스케일 차이가 큰 데이터셋에서 분산-공분산 행렬의 역행렬을 계산하는 데 필요하다. 기본값은 `base::solve()` 함수에서 사용하는 값보다 훨씬 크다. `control` 인수는 추정 함수의 실행을 세밀하게 조정하는 제어값 리스트를 받는다.

`sacsarlm()` 함수는 SAC 및 GNM 형식에서 두 개의 공간 프로세스를 모형화할 때 서로 다른 두 개의 공간 가중치를 사용할 수 있도록, 두 번째 공간 가중치와 `interval` 인수를 받을 수 있다. 기본값은 동일한 공간 가중치를 사용하는 것이며, 수치 최적화에는 기본적으로는 **stats** 패키지의 `nlminb()` 함수가 사용된다. 시작값은 휴리스틱이 방식으로 선택된다. `lagsarlm()`함수와 마찬가지로 `weights` 인수는 지원하지 않는다.

대규모 데이터셋을 사용할 경우, 계수의 분산-공분산 행렬 계산 시 분석적 점근적(analytic asymptotic) 접근 방식 대신 수치적 헤세 행렬(numerical Hessian) 접근 방식이 사용된다.(역자주: '분석적 점근적' 접근 방식은 수학적으로 유도된 공식에 따라 분산–공분산 행렬을 계산하는 방법이며, 표본 크기가 충분히 크다는 가정하에 효율적이다. 반면, '수치적 헤세 행렬' 접근 방식은 모수에 대한 로그우도의 2차 미분을 수치적으로 근사하여 행렬을 구하는 방법으로, 대규모 데이터셋에서 계산 안정성과 정확성을 확보하기 위해 사용된다.)

### 보스턴 주택 가격 데이터셋 예시

다음 예제는 Bivand(2017)를 기반으로 하며, 16장에서 생성된 객체들을 활용한다.

```{r}
#| eval: false
library(spatialreg)
eigs_489 <- eigenw(lw_q_489)
SDEM_489 <- errorsarlm(form, data = boston_489, 
      listw = lw_q_489, Durbin = TRUE, zero.policy = TRUE,
      control = list(pre_eig = eigs_489))
SEM_489 <- errorsarlm(form, data = boston_489, 
      listw = lw_q_489, zero.policy = TRUE,
      control = list(pre_eig = eigs_489))
```

기본값인 `"eigen"` 방법을 사용할 경우, 미리 계산된 고유값을 `control` 리스트 인수를 통해 전달할 수 있다.

```{r}
#| eval: false
cbind(data.frame(model=c("SEM", "SDEM")), 
      rbind(broom::tidy(Hausman.test(SEM_489)), 
            broom::tidy(Hausman.test(SDEM_489))))[,1:4]
#   model statistic  p.value parameter
# 1   SEM      52.0 2.83e-06        14
# 2  SDEM      48.7 6.48e-03        27
```

489개의 트랙트 데이터셋에 대한 두 가지 Hausman 검정 결과, 회귀계수가 비공간적 회귀분석의 회귀계수와 유의하게 다르다는 점이 확인되었으며, 이는 공간 프로세스의 패턴이 일치하지 않음을 시사한다.(역자주: Hausman 검정은 두 추정량이 모두 일관성을 가지지만 한쪽이 더 효율적일 것으로 가정될 때, 그 효율성이 실제로 유지되는지 확인하는 통계 검정이다. 공간통계 분석에서는 비공간 회귀와 공간 회귀의 계수를 비교하여, 계수 차이가 유의하면 공간 효과가 존재함을 시사한다.)

```{r}
#| eval: false
eigs_94 <- eigenw(lw_q_94)
SDEM_94 <- errorsarlm(form, data=boston_94, listw=lw_q_94,
                      Durbin = TRUE,
                      control = list(pre_eig=eigs_94))
# Warning in RET$pfunction("adjusted", ...): Completion with error >
# abseps

# Warning in RET$pfunction("adjusted", ...): Completion with error >
# abseps

# Warning in RET$pfunction("adjusted", ...): Completion with error >
# abseps

# Warning in RET$pfunction("adjusted", ...): Completion with error >
# abseps
SEM_94 <- errorsarlm(form, data = boston_94, listw = lw_q_94,
                     control = list(pre_eig = eigs_94))
```

94개의 대기오염 모형 출력 구역에 대한 Hausman 검정에서는 계수 간 유의한 차이가 발견되지 않았다.

```{r}
#| eval: false
cbind(data.frame(model=c("SEM", "SDEM")), 
      rbind(broom::tidy(Hausman.test(SEM_94)), 
            broom::tidy(Hausman.test(SDEM_94))))[, 1:4]
#   model statistic p.value parameter
# 1   SEM     15.66   0.335        14
# 2  SDEM      9.21   0.999        27
```

이러한 결과는 SEM과 SDEM 모형이 대기오염 모형 출력 구역 수준에서 최소제곱법이나 SLX 모형에 비해 거의 추가적인 차이를 만들지 않았음을 보여준다. 이러한 사실은 우도비 검정을 통해 확인할 수 있다.

```{r}
#| eval: false
cbind(data.frame(model=c("SEM", "SDEM")),
      rbind(broom::tidy(LR1.Sarlm(SEM_94)),
            broom::tidy(LR1.Sarlm(SDEM_94))))[,c(1, 4:6)]
#   model statistic p.value parameter
# 1   SEM     2.593   0.107         1
# 2  SDEM     0.216   0.642         1
```

**spatialreg** 패키지의 `LR.Sarlm()` 함수를 사용하면 중첩(nested) 모형 간 우도비 검정을 실행할 수 있지만, 여기서는 **lmtest** 패키지의 `lrtest()` 함수를 사용하며, 결과는 동일하다.(역자주: 여기서 ‘중첩 모형’이란 하나의 모형이 다른 모형의 특수한 형태로 포함되어 있는 경우를 말한다. 예를 들어, 공간 더빈 모형(SDM)에서 일부 계수를 0으로 두면 공간래그모형(SLM)이 되므로, SLM은 SDM에 중첩되어 있다. 우도비 검정은 이러한 중첩 관계를 전제로 두 모형의 적합도를 비교한다.) 트랙트와 모형 출력 구역 모두에서 공간래그 공변량을 포함하는 모형이 더 선호된다는 것으로 나타났다.

```{r}
#| eval: false
o <- lmtest::lrtest(SEM_489, SDEM_489)
attr(o, "heading")[2] <- "Model 1: SEM_489\nModel 2: SDEM_489"
o
# Likelihood ratio test
# 
# Model 1: SEM_489
# Model 2: SDEM_489
#   #Df LogLik Df Chisq Pr(>Chisq)    
# 1  16    274                        
# 2  29    311 13  74.4    1.2e-10 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

```{r}
#| eval: false
o <- lmtest::lrtest(SEM_94, SDEM_94)
attr(o, "heading")[2] <- "Model 1: SEM_94\nModel 2: SDEM_94"
o
# Likelihood ratio test
# 
# Model 1: SEM_94
# Model 2: SDEM_94
#   #Df LogLik Df Chisq Pr(>Chisq)    
# 1  16   59.7                        
# 2  29   81.3 13  43.2    4.2e-05 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

SLX 모형은 최소제곱법으로 적합되며, 로그우도 값을 반환하므로 잔차에 공간 프로세스 요소를 포함할 필요가 있는지를 검정할 수 있다. 트랙트 데이터셋의 경우, 이를 포함해야 한다는 결과가 명확히 나타났다.

```{r}
#| eval: false
SLX_489 <- lmSLX(form, data = boston_489, listw = lw_q_489,
                 zero.policy = TRUE)
o <- lmtest::lrtest(SLX_489, SDEM_489)
attr(o, "heading")[2] <- "Model 1: SLX_489\nModel 2: SDEM_489"
o
# Likelihood ratio test
# 
# Model 1: SLX_489
# Model 2: SDEM_489
#   #Df LogLik Df Chisq Pr(>Chisq)    
# 1  28    231                        
# 2  29    311  1   159     <2e-16 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

그러나 모형 출력 구역 데이터에서는 그와 반대되는 결과가 나타났다.

```{r}
#| eval: false
SLX_94 <- lmSLX(form, data = boston_94, listw = lw_q_94)
o <- lmtest::lrtest(SLX_94, SDEM_94)
attr(o, "heading")[2] <- "Model 1: SLX_94\nModel 2: SDEM_94"
o
# Likelihood ratio test
# 
# Model 1: SLX_94
# Model 2: SDEM_94
#   #Df LogLik Df Chisq Pr(>Chisq)
# 1  28   81.2                    
# 2  29   81.3  1  0.22       0.64
```

이러한 결과는 주택 단위 수를 트랙트와 모형 출력 구역별로 집계해 사례 가중치를 적용했을 때도 동일하게 유지되었다.

```{r}
#| eval: false
SLX_489w <- lmSLX(form, data = boston_489, listw = lw_q_489,
                  weights = units, zero.policy = TRUE)
SDEM_489w <- errorsarlm(form, data = boston_489,
                        listw = lw_q_489, Durbin = TRUE,
                        weights = units, zero.policy = TRUE,
                        control = list(pre_eig = eigs_489))
o <- lmtest::lrtest(SLX_489w, SDEM_489w)
attr(o, "heading")[2] <- "Model 1: SLX_489w\nModel 2: SDEM_489w"
o
# Likelihood ratio test
# 
# Model 1: SLX_489w
# Model 2: SDEM_489w
#   #Df LogLik Df Chisq Pr(>Chisq)    
# 1  28    311                        
# 2  29    379  1   136     <2e-16 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

```{r}
#| eval: false
SLX_94w <- lmSLX(form, data = boston_94, listw = lw_q_94,
                 weights = units)
SDEM_94w <- errorsarlm(form, data = boston_94, listw = lw_q_94,
                       Durbin = TRUE, weights = units,
                       control = list(pre_eig = eigs_94))
o <- lmtest::lrtest(SLX_94w, SDEM_94w)
attr(o, "heading")[2] <- "Model 1: SLX_94w\nModel 2: SDEM_94w"
o
# Likelihood ratio test
# 
# Model 1: SLX_94w
# Model 2: SDEM_94w
#   #Df LogLik Df Chisq Pr(>Chisq)
# 1  28   97.5                    
# 2  29   98.0  1  0.92       0.34
```

이 경우와 Bivand(2017)에서 제시된 논거를 바탕으로, 가중치 사용은 정당화된다. 이는 주택 단위 수가 트랙트의 경우 5개에서 3,031개까지, 대기오염 모형 출력 구역의 경우는 25개에서 12,411개까지 다양하기 때문이다. 이러한 이유와, 가중치를 활용하는 GNM 모형이 아직 개발되지 않았다는 점 때문에, GNM 모형을 출발점으로 삼아 일반 모형에서 더 단순한 모형으로의 검정을 수행할 수 없다. 대신 SDEM 모형을 출발점으로 설정하고, Hausman 검정을 사용하여 관측 단위 선택에 지침을 얻는다.

## 공간 효과 추정

전역적 효과는 공간래그 반응변수를 포함하는 모형(SLM, SDM, SAC, GNM)의 적합 결과를 보고할 때 핵심적인 요소로 간주된다(LeSage and Pace 2009). 전역적 효과를 공간래그 공변량(SLX, SDEM)을 포함하는 다른 모형으로 확장하려는시도도 이루어졌다(Elhorst 2010; Bivand 2012; Halleck Vega and Elhorst 2015). SLM, SDM, SAC, GNM 모형은 MLE 또는 GMM을 사용하여 적합시킬 경우, 계수의 분산-공분산 행렬을 활용할 수 있다. 계수 추정치를 평균으로 하고, 추정된 분산-공분산 행렬로부터 분산을 가져와 다변량 정규분포를 구성한 뒤, 이로부터 난수를 추출할 수 있다. 베이지안 방법으로 적합한 경우에는 샘플이 사전에 주어지므로 별도의 추출이 필요 없다. SDEM의 경우, 비래그 공변량의 회귀계수에 대한 샘플은 직접(direct) 효과를 나타내고, 공간래그 공변량의 회귀계수에 대한 샘플은 간접(indirect) 효과를 나타내며, 이 둘을 합한 값이 총(total) 효과를 이룬다.

SLX와 SDEM 모형에서는 추론을 위해 샘플링이 필요하지 않으므로, MLE로 적합된 모형에 대해서는 선형결합을 사용한다. 여기서는 공기오염 변수에 대해서만 결과를 제시한다. 모형 출력 보고 방법과 관련된 문제는 아직 완전히 해결되지 않았다. 이는 개별 공변량에 대해 세 가지 효과 값을 보고해야 하기 때문이다. 공간래그 공변량이 포함될 경우, 기존의 두 개의 계수는 세 가지 효과로 대체된다. 여기서는 공기오염 변수에 대한 예시를 보여준다.

```{r}
#| eval: false
sum_imp_94_SDEM <- summary(impacts(SDEM_94))
rbind(Impacts = sum_imp_94_SDEM$mat[5,], 
      SE = sum_imp_94_SDEM$semat[5,])
#           Direct Indirect   Total
# Impacts -0.01276 -0.01845 -0.0312
# SE       0.00235  0.00472  0.0053
```

SLX와 SDEM 모형에서 직접 효과는 동일한 관측 단위에서 공기오염 변화가 반응변수에 미치는 영향이며, 간접 효과(지역 효과)는 인접한 관측 단위에서 공기오염 변화가 반응변수에 미치는 영향이다.

```{r}
#| eval: false
sum_imp_94_SLX <- summary(impacts(SLX_94))
rbind(Impacts = sum_imp_94_SLX$mat[5,], 
      SE = sum_imp_94_SLX$semat[5,])
#          Direct Indirect    Total
# Impacts -0.0128 -0.01874 -0.03151
# SE       0.0028  0.00556  0.00611
```

같은 방법을 가중 공간 회귀분석에 적용한 결과, 공기오염이 주택 가치에 미치는 총 효과는 감소했으나 여전히 통계적으로 유의하였다.

```{r}
#| eval: false
sum_imp_94_SDEMw <- summary(impacts(SDEM_94w))
rbind(Impacts = sum_imp_94_SDEMw$mat[5,], 
      SE = sum_imp_94_SDEMw$semat[5,])
#           Direct Indirect    Total
# Impacts -0.00592 -0.01076 -0.01668
# SE       0.00269  0.00531  0.00559
```

전체적으로, 대기오염 모형 출력 구역 수준으로 집계된 공간래그 공변량만을 포함하는 가중 공간 회귀모형이 대부분의 모형 오지정 오류를 해결하는 것으로 보인다. Bivand(2017)에서 더 자세히 논의된 바와 같이, 이는 오지정된 대체 모형들보다 오염 제거에 대한 지불의향이 훨씬 더 크다는 점을 보여준다.

```{r}
#| eval: false
sum_imp_94_SLXw <- summary(impacts(SLX_94w))
rbind(Impacts = sum_imp_94_SLXw$mat[5,], 
      SE = sum_imp_94_SLXw$semat[5,])
#           Direct Indirect    Total
# Impacts -0.00620 -0.01221 -0.01842
# SE       0.00326  0.00628  0.00629
```

## 예측

보스턴 구역 데이터셋에서 응답변수인 중위 주택가격의 17개 관측치가 누락되어 있다. 이를 채우기 위해 `"Sarlm"` 객체에 대한 `predict()` 메서드를 사용한다. 이 메서드는 Goulard, Laurent, and Thomas-Agnan(2017)을 기반으로 마틴 구브리(Martin Gubri)가 재작성하였으며 Laurent와 Margaretic(2021)도 참고할 수 있다. `pred.type` 인수는 해당 논문에서 제시된 예측 전략을 지정한다.

이 예시에서는 `pred.type` 설정을 달리하여 SDEM 모형의 다양한 변종으로 샘플 외 예측을 수행한다. 이를 통해 예측 결과의 차이를 확인할 수 있으며, 이는 연구할 가치가 있는 중요한 주제임을 시사한다. 누락 변수 처리에 대해서는 여러 대안이 제시되어 있다(Gómez-Rubio, Bivand, and Rue 2015; Suesse 2018). 예측에 대한 관심이 높아지는 또 다른 이유는, 예측이 기계학습(machine learning) 접근 방식의 기본 요소이기 때문이다. 기계학습에서는 검증 및 테스트 데이터셋을 대상으로 한 예측 성능이 모형 사양 선택을 이끈다. 그러나 공간적 의존성을 지닌 공간데이터에서 훈련 및 검정 데이터셋을 선택하는 문제는 여전히 해결되지 않았으며, 이는 독립 표본 데이터의 경우와는 확연히 다른 복잡성을 지닌다.

여기서는 검열된 트랙트 관측값에 대해 세 가지 상이한 예측 유형을 적용하고, USD 단위의 주택 중위값으로 복원하기 위해 지수 변환을 수행한다. 이때 `newdata` 객체의 `row.names()` 함수가 공간 가중치 행렬의 `"region.id"` 속성과 일치해야 샘플 외 예측이 가능하다는 점에 유의해야 한다.

```{r}
#| eval: false
nd <- boston_506[is.na(boston_506$median),]
t0 <- exp(predict(SDEM_489, newdata = nd, listw = lw_q,
                  pred.type = "TS", zero.policy  =TRUE))
suppressWarnings(t1 <- exp(predict(SDEM_489, newdata = nd,
                                    listw = lw_q,
                                    pred.type = "KP2",
                                    zero.policy = TRUE)))
suppressWarnings(t2 <- exp(predict(SDEM_489, newdata = nd,
                                    listw = lw_q,
                                    pred.type = "KP5",
                                    zero.policy = TRUE)))
```

**INLA** 패키지의 `"slm"` 모형을 사용하면 모형 적합 함수 호출 과정에서 누락된 반응변수 값을 함께 예측할 수 있다. 다만 `"slm"` 모형은 아직 실험적 단계이므로 약간의 설정 코드가 필요하다.

```{r}
#| eval: false
library(INLA)
# Loading required package: foreach
# Loading required package: parallel
# Loading required package: sp
# This is INLA_23.04.24 built 2023-04-24 19:15:35 UTC.
#  - See www.r-inla.org/contact-us for how to get help.
#  - To enable PARDISO sparse library; see inla.pardiso()
# 
# Attaching package: 'INLA'
# The following object is masked _by_ '.GlobalEnv':
# 
#     f
W <- as(lw_q, "CsparseMatrix")
n <- nrow(W)
e <- eigenw(lw_q)
re.idx <- which(abs(Im(e)) < 1e-6)
rho.max <- 1 / max(Re(e[re.idx]))
rho.min <- 1 / min(Re(e[re.idx]))
rho <- mean(c(rho.min, rho.max))
boston_506$idx <- 1:n
zero.variance = list(prec = list(initial = 25, fixed = TRUE))
args.slm <- list(rho.min = rho.min, rho.max = rho.max, W = W,
                 X = matrix(0, n, 0), Q.beta = matrix(1,0,0))
hyper.slm <- list(prec = list(prior = "loggamma", 
                              param = c(0.01, 0.01)),
                  rho = list(initial = 0, prior = "logitbeta",
                             param = c(1,1)))
WX <- create_WX(model.matrix(update(form, CMEDV ~ .), 
                             data = boston_506), lw_q)
SDEM_506_slm <- inla(update(form, 
                            . ~ . + WX + f(idx, model = "slm",
                                         args.slm = args.slm,
                                         hyper = hyper.slm)),
                 data = boston_506, family = "gaussian",
                 control.family = list(hyper = zero.variance),
                 control.compute = list(dic = TRUE, cpo = TRUE))
mv_mean <- exp(SDEM_506_slm$summary.fitted.values$mean[
               which(is.na(boston_506$median))])
```

**INLA** 패키지는 예측값에 대한 주변분포(marginal distribution)의 격자형 추정치를 제공하며, 이를 통해 예측값에 내재된 불확실성을 평가할 수 있다.(역자주: 여기서 ‘예측값에 대한 주변분포’란 각 예측값이 가질 수 있는 불확실성을 나타내는 확률분포를 말한다. **INLA** 패키지는 이를 일정 간격의 격자점에서 계산하여 근사하는 방식을 사용하며, 이를 통해 예측값의 신뢰구간이나 변동 범위를 평가할 수 있다.)

```{r}
#| eval: false
data.frame(fit_TS = t0[,1], fit_KP2 = c(t1), fit_KP5 = c(t2),
    INLA_slm = mv_mean, censored = 
      boston_506$censored[as.integer(attr(t0, "region.id"))])
#     fit_TS fit_KP2 fit_KP5 INLA_slm censored
# 13   23912   29477   28147    31112    right
# 14   28126   27001   28516    31314    right
# 15   30553   36184   32476    41298    right
# 17   18518   19621   18878    21160    right
# 43    9564    6817    7561     6830     left
# 50    8371    7196    7383     6885     left
# 312  51477   53301   54173    56274    right
# 313  45921   45823   47095    46447    right
# 314  44196   44586   45361    42805    right
# 317  43427   45707   45442    48025    right
# 337  39879   42072   41127    41462    right
# 346  44708   46694   46108    45847    right
# 355  48188   49068   48911    49138    right
# 376  42881   45883   44966    47747    right
# 408  44294   44615   45670    46164    right
# 418  38211   43375   41914    43913    right
# 434  41647   41690   42398    41551    right
```

공간적 회귀분석을 위한 도구 모음은 여전히 완전하지 않으며, 그 빈틈을 메우는 데는 시간이 필요하다. 여러 공간적 회귀분석 전통 간에 이해와 발전을 거의 공유하지 않는 점은 여전히 아쉬운 부분이다.

## 연습문제

1.  Piras와 Prucha(2014), 그리고 Raymond J. G. M. Florax, Folmer, Rey(2003)를 참조하여, 사전 테스트 전략을 선택했을 때, 속성만 포함된 데이터셋과 지자체 구역 변수를 추가한 속성 데이터셋의 선형모형에서 잔차의 공간적 의존성이 나타나는지 답하시오. 사전 테스트가 어떤 모형을 지목하는지에 대해 답하시오.

2.  자치구역 더미 변수를 포함하거나 자치구역 레짐(regime) 모형을 실행하는 것이 잔차의 공간적 의존성을 줄이는 데 도움이 될 수 있는지에 대해 답하시오.

3.  속성만 포함한 모형과 자치구역 변수를 추가한 모형에 대해 MLE를 사용하여 SEM 모형을 실행하시오(GMM 코드 예시는 Bivand, Millo와 Piras(2021)를 참조). 이어서 SDEM 모형으로 확장하시오. 또한 SLX 모형을 실행하고, 해당 모형의 잔차에 대한 공간적 자기상관 검정 결과를 해석하시오. SEM과 SDEM 모형에 대한 Hausman 검정에서 나타난 매우 높은 유의성을 해석하시오.

4.  속성만 포함한 모형과 자치구역 변수를 추가한 모형에 대해 GNM 모형을 실행하시오. 이러한 모형을 SDM 또는 SDEM 형식으로 단순화할 수 있는지에 대해 답하시오.

5.  16장 연습문제에서 얻은 모형 추정 결과가 이 장의 결과보다 더 명확한 통찰을 제공하는지에 대해 답하시오.
