---
date-modified: last-modified
number-sections: true
format: 
  html: 
    toc: true
code-link: true
code-copy: true
execute: 
  warning: false
  error: false
  freeze: auto
editor: visual
---

# 공간적 자기상관 측도 {#sec-autocorrelation}

에어리어 데이터를 분석할 때, 공간적 자기상관이 존재한다면, 독립적인 관찰이라는 기본 가정에 입각한 것과는 다른 추론 방식이 적용되어야 한다는 점은 오래전부터 인식되어 왔다. 공간적 자기상관이 존재하는 경우, 관측개체 $i$의 값을 관측개체 $j$의 값으로 예측할 수 있는데, $j$는 $i$에 인접한 이웃들의 집합인 $N_i$의 한 원소이다. 선구적인 연구 결과(Moran 1948; Geary 1954)가 점진적인 수용 과정을 거치고(사회과학 분야의 예: Duncan, Cuzzort, and Duncan 1961). 이후 이러한 결과들이 정리되고 확장되어 정량적 분석을 위한 기본 도구로 발전해 나갔다(Cliff and Ord 1973, 1981).

Cliff와 Ord(1973)는 다양한 공간적 통계량, 즉 조인-카운트 통계량, 모런 통계량(Moran's $I$), 기어리 통계량(Geary's $C$)에 공통적으로 적용가능한 분포 이론을 확립하고자 했으며, 이러한 과정에 공간 가중치 행렬 개념을 일반화하고 확장하는 것이 힘을 쏟았다. 전체 연구 지역에 대해 하나의 공간적 자기상관 값을 반환한다는 의미에서 이러한 통계량을 전역적 측도라고 부르며, 이후에 개별 구역단위에 공간적 자기상관 값을 산출하는 국지적 측도(Getis and Ord 1992; Anselin 1995)의 발전으로 이어졌다.

**spdep** 패키지는 다양한 측도를 계산할 수 있게 해준다는 의미에서 뿐만 아니라 측도간 비교 분석을 진작한다는 의미로 설계되었다. 이러한 이유로 측도 함수는 컴파일된 코드가 아닌 R로 작성되었으며, 최근 선보인 **rgeoda** 패키지(Li and Anselin 2021; Anselin, Li, and Koschinsky 2021)보다 속도가 느리긴 하지만 더 유연하다.

## 측도와 프로세스 오지정

Tobler(1970)가 말한 지리학의 제1법칙, 즉 “모든 것은 다른 모든 것과 연관되어 있다. 그러나 가까이 있는 것은 멀리 떨어져 있는 것보다 더 많이 연관되어 있다”가 만고의 진리인 것으로 취급되어서는 안된다. 이는 지나치게 단순화된 개념으로 다른 잠재적 문제들, 즉 개체화(entitation)의 문제(역자주: 사용된 공간단위가 해당 공간적 현상을 분석하기에 적당한 것인가와 관련된 문제로 소위 '공간단위 임의성의 문제(MAUP, modifiable areal unit problem)'와 관련된 것이다), 스포트의 문제, 기타 오지정(misspecification)의 문제(역자주: 통계 모델에서 해당 현상을 설명하기에 적절하지 않은 방식으로 변수 설정이 이루어진 경우를 통칭하는 용어인데, 주로 주요 변수의 누락이 야기하는 문제를 지적한다)를 덮어 버릴 수 있다. 관측 단위의 크기가 기저의 공간 프로세스의 스케일에 부합하는가? 주어진 관측 단위 하에서 표출된 관심 변수의 공간적 패턴이 다른 변수의 공간적 패턴으로 설명될 수 있는가?

토블러(Tobler, 1970)의 논문은 올슨(Olsson, 1970)의 논문과 함께 *Economic Geography*의 특별호에 실렸다. 하지만 올슨은 공간적 자기상관이 공간적 현상에 필연적으로 내재되어 있는 것이 아니라, 부적절한 개체화, 누락된 변수, 그리고/또는 부적절하게 설정된 함수 관계에 의해 발생하는 경우가 더 많다는 점을 간파했다. Olsson의 핵심 인용구는 228쪽에 있다.

> 이러한 자기상관의 존재는 Tobler(1970)의 “모든 것은 다른 모든 것과 연관되어 있다. 그러나 가까이 있는 것은 멀리 떨어져 있는 것보다 더 많이 연관되어 있다”는 주장에 동의하고 싶어지게 만든다. 그러나 한편으로 이러한 자기상관이 체계적인 오지정 오류를 감추는 것처럼 보인다는 사실은 이 주장을 ‘지리학의 제1법칙’으로 격상시키는 것이 우선은 성급하다는 점을 시사한다. 최악의 경우, 이 주장은 사후 오류(post hoc fallacy)(단순한 우연을 인과 관계로 잘못 해석하는 오류)의 공간적 변형에 불과한 것일 수 있다.

“제1법칙”으로서의 지위는 존 스노(John Snow)가 콜레라의 원인이 수인성이라는 것을 지도로부터 유도해냈다는 믿음과 매우 유사하다. 이는 GIS를 홍보하는 좋은 방법일 수 있지만, 부정확한 것이다. Snow는 Soho를 방문하기 전에 이미 강력한 작업 가설을 가지고 있었고, 그 지도는 Broad Street 펌프가 차단된 후 그의 가설이 맞다는 것을 문서화하기 위해 작성된 것이었다(Brody et al. 2000).

불행히도 공간적 자기상관 측도는 우리가 데이터를 모델링하는 과정에서 저지른 다른 오지정 오류를 반영한다(Schabenberger and Gotway 2005; McMillen 2003). 참고로, 모런 통계량은 다음과 같이 주어진다(Cliff and Ord 1981, 17).

$$
I=\frac {n\sum_{(2)}w_{ij} z_i z_j}{S_0\sum^n_{i=1}z^2_i}
$$

여기서 $z_i=x_i-\bar{x}$, $x_i$는 해당 변수의 $n$개의 관측값 중 하나, $\bar{x}=\sum^n_{i=1}x_i/n$, $\sum_{(2)}=\sum^n_{i=1}\sum^n_{j=1}(i\neq j)$, $w_{ij}$는 공간적 가중치, $S_0=\sum_{(2)}w_{ij}$이다. 먼저 우리는 무작위 확률 변수에 대해 공간적 자기상관을 검토하고자 하는데, 정규성 가정(아규먼트를 `randomisation=FALSE`로 지정) 하에서 모런 검정을 행한다. 검정통계량은 $Z(I)=\frac{I-E(I)}{\sqrt{Var(I)}}$로, 산출된 z-값을 $E(I)$와 $Var(I)$를 가진 정규분포와 대조한다. 아래는 무작위 확률 변수에 공간적 자기상관이 존재하지 않는다는 검정 결과이다.

```{r}
#| eval: false
library(spdep) |> suppressPackageStartupMessages()
library(parallel)
glance_htest <- function(ht) c(ht$estimate, 
    "Std deviate" = unname(ht$statistic), 
    "p.value" = unname(ht$p.value))
set.seed(1)
(pol_pres15 |> 
    nrow() |> 
    rnorm() -> x) |> 
    moran.test(lw_q_B, randomisation = FALSE,
               alternative = "two.sided") |> 
    glance_htest()
# Moran I statistic       Expectation          Variance 
#         -0.004772         -0.000401          0.000140 
#       Std deviate           p.value 
#         -0.369320          0.711889
```

그런데 약간의 공간적 경향성을 가진 가상의 변수를 생성하고 그것을 또 다른 변수로 간주하는 대신 원 무작위 변수와 합산했다고 하자. 이 상태에서 동일한 검정을 적용하면 이번에는 강한 공간적 자기상관이 나타나게 된다. 공간적 경향성을 가진 변수를 모델에 포함시키지 않았다는 측면에서 변수 누락의 문제가 있는 것인데 그것이 공간적 자기상관의 문제로 전이된 것이다.

```{r}
#| eval: false
beta <- 0.0015
coords |> 
    st_coordinates() |> 
    subset(select = 1, drop = TRUE) |> 
    (function(x) x/1000)() -> t
(x + beta * t -> x_t) |> 
    moran.test(lw_q_B, randomisation = FALSE,
               alternative = "two.sided") |> 
    glance_htest()
# Moran I statistic       Expectation          Variance 
#          0.043403         -0.000401          0.000140 
#       Std deviate           p.value 
#          3.701491          0.000214
```

공간적 경향성을 가진 변수를 선형 모델에 독립적인 변수로 투입하면, 잔차에서 공간적 자기상관이 사라진 것을 확인할 수 있다.

```{r}
#| eval: false
lm(x_t ~ t) |> 
    lm.morantest(lw_q_B, alternative = "two.sided") |> 
    glance_htest()
# Observed Moran I      Expectation         Variance      Std deviate 
#        -0.004777        -0.000789         0.000140        -0.337306 
#          p.value 
#         0.735886
```

다양한 공간적 자기상관 측도가 다양한 R 패키지에서 이용가능하다. 그 중에서 **spdep** 패키지(Bivand 2022b)가 핵심적 역할을 담당하며, 패키지간 차이는 주로 실행 디자인과 관련되어 있다(Bivand and Wong 2018). **spdep** 패키지를 통해 회귀 잔차에 대한 전역적 및 국지적 모런 검정을 행할 수 있으며, 다른 패키지와 달리 정확(exact) 및 안장점 근사법(Tiefelsdorf 2002; Bivand, Müller, and Reder 2009)을 제공한다.

## 전역적 측도

### 범주 데이터를 위한 조인-카운트 통계량

먼저 조인-카운트(join-count) 통계량을 살펴본다. 여기서 `joincount.test` 함수는 `"factor"` 값 벡터 `fx`와 `listw` 객체를 입력받고, **stats** 패키지에서 정의된 `htest`(가설 검정) 객체들의 리스트를 반환한다. 반환되는 `htest` 객체는 `fx` 아규먼트의 각 수준에 대해 하나씩 생성된다. 관찰된 카운트는 동일한 범주 수준을 가진 이웃쌍의 수로, 이를 동일 색상 조인(same-colour joins)이라고 한다.

```{r}
#| eval: false
args(joincount.test)
```

``` r
#  function (fx, listw, zero.policy = NULL, alternative = "greater",
#    sampling = "nonfree", spChk = NULL, adjust.n = TRUE)
```

이 함수는 가설 검정을 위한 `alternative` 아규먼트와 통계량의 분산을 구성하는 기준을 나타내는 `sampling` 아규먼트를 입력받는다. 기본값인 `"nonfree"`는 개념적으로 분석적 순열(analytical permutation)과 동일한 것이다. `spChk` 아규먼트는 이전 버전과의 호환성을 위해 유지된다. 참고로, 앞에서 살펴본 지방자치단체 및 바르샤바 데이터에 대한 범주 유형별 카운트는 다음과 같다.

```{r}
#| eval: false
(pol_pres15 |> 
        st_drop_geometry() |> 
        subset(select = types, drop = TRUE) -> Types) |> 
    table()
# 
#          Rural          Urban    Urban/rural Warsaw Borough 
#           1563            303            611             18
```

네 개의 범주 유형, 즉 네 개의 수준이 있으므로, `htest` 객체 리스트를 재배열하여 추정된 결과를 나타내는 행렬을 생성한다. 관찰된 동일-컬러 조인 카운트는 입력된 범주 수준의 카운트를 기반으로 한 기대값과 함께 표로 정리된다. 예를 들어 바르샤바 구역 간에는 결합이 거의 없을 것으로 예상된다. 이는 구역의 수가 매우 적기 때문이다. 분산 계산은 선택된 `listw` 객체의 기본 상수와 입력 범주 수준의 카운트를 사용하여 수행된다. z-값은 관찰된 조인 카운트와 기대값의 차이를 분산의 제곱근으로 나누어 얻어진다.

조인-카운트 검정은 컬러 멀티-컬러 조인 카운트 상황으로의 확장을 위해 수정되었다(Upton and Fingleton 1985). **spdep**에서 `joincount.multi` 함수로 구현되었는데 비자유 샘플링(non-free sampling)을 기반으로 표를 반환하며, p-값은 보고하지 않는다.

```{r}
#| eval: false
Types |> joincount.multi(listw = lw_q_B)
#                               Joincount Expected Variance z-value
# Rural:Rural                    3087.000 2793.920 1126.534    8.73
# Urban:Urban                     110.000  104.719   93.299    0.55
# Urban/rural:Urban/rural         656.000  426.526  331.759   12.60
# Warsaw Borough:Warsaw Borough    41.000    0.350    0.347   68.96
# Urban:Rural                     668.000 1083.941  708.209  -15.63
# Urban/rural:Rural              2359.000 2185.769 1267.131    4.87
# Urban/rural:Urban               171.000  423.729  352.190  -13.47
# Warsaw Borough:Rural             12.000   64.393   46.460   -7.69
# Warsaw Borough:Urban              9.000   12.483   11.758   -1.02
# Warsaw Borough:Urban/rural        8.000   25.172   22.354   -3.63
# Jtot                           3227.000 3795.486 1496.398  -14.70
```

바이너리 가중치를 적용하는 상항에서는 조인-카운트의 합에 해당 조인에 대한 가중치를 곱한 값도 여전히 정수로 나타난다. 만약 행표준화 가중치를 적용하게 되면, 가중치가 대부분 1보다 작은 분수가 되기 때문에 카운트, 기대값, 분산은 달라진다. 그러나 최종적인 z-값에는 큰 변화가 없다.

그러나 역거리 기반의 `listw` 객체를 사용하면 z-값이 크게 변한다. 이는 가까운 센트로이드에 상대적으로 강한 가중치가 부여되기 때문이다.

```{r}
#| eval: false
Types |> joincount.multi(listw = lw_d183_idw_B)
#                               Joincount Expected Variance z-value
# Rural:Rural                    3.46e+02 3.61e+02 4.93e+01   -2.10
# Urban:Urban                    2.90e+01 1.35e+01 2.23e+00   10.39
# Urban/rural:Urban/rural        4.65e+01 5.51e+01 9.61e+00   -2.79
# Warsaw Borough:Warsaw Borough  1.68e+01 4.53e-02 6.61e-03  206.38
# Urban:Rural                    2.02e+02 1.40e+02 2.36e+01   12.73
# Urban/rural:Rural              2.25e+02 2.83e+02 3.59e+01   -9.59
# Urban/rural:Urban              3.65e+01 5.48e+01 8.86e+00   -6.14
# Warsaw Borough:Rural           5.65e+00 8.33e+00 1.73e+00   -2.04
# Warsaw Borough:Urban           9.18e+00 1.61e+00 2.54e-01   15.01
# Warsaw Borough:Urban/rural     3.27e+00 3.25e+00 5.52e-01    0.02
# Jtot                           4.82e+02 4.91e+02 4.16e+01   -1.38
```

### 모런 통계량

**spdep** 패키지에서 모런 통계량은 `moran.test` 함수로 구현되어 있다. 이 함수는 `joincount.test` 함수와 유사한 아규먼트를 가지지만, 샘플링 대신 랜덤화(randomisation)를 사용하여 측정의 분산을 계산한다. 또한 수치 값 대신 순위를 사용할 수도 있다(Cliff and Ord 1981, 46). 일부 오래된 소프트웨어에서는 분산 항목의 마지막 구성 요소가 생략된채 나타나는데, `drop.EI2` 아규먼트는 그것을 재현해준다.

```{r}
#| eval: false
args(moran.test)
```

``` r
#  function (x, listw, randomisation = TRUE, zero.policy = NULL,
#    alternative = "greater", rank = FALSE, na.action = na.fail,
#    spChk = NULL, adjust.n = TRUE, drop.EI2 = FALSE)
```

`randomisation` 아규먼트의 디폴트는 `TRUE`인데, `FALSE`를 지정하게 되면 정규성 가정 하에서의 검정을 수행하게 된다. 아래의 사례를 통해, 단일 변수에 정규성 가정을 적용한 검정 결과와 절편만이 포함된 회귀 모델의 잔차에 대한 랜덤화 가정 하에서의 검정 결과가 동일하게 나타난다는 점을 알게 될 것이다. 해당 변수는 2015년 폴란드 대통령 선거의 투표율이다. `randomisation`의 철자는 Cliff와 Ord (1973)의 방식에 따른 것이다.

```{r}
#| eval: false
pol_pres15 |> 
        st_drop_geometry() |> 
        subset(select = I_turnout, drop = TRUE) -> I_turnout
```

```{r}
#| eval: false
I_turnout |> moran.test(listw = lw_q_B, randomisation = FALSE) |> 
    glance_htest()
# Moran I statistic       Expectation          Variance 
#          0.691434         -0.000401          0.000140 
#       Std deviate           p.value 
#         58.461349          0.000000
```

`lm.morantest` 함수는 `resfun` 아규먼트도 가지고 있는데, 이를 통해 검정을 위한 잔차를 추출하는 함수를 설정할 수 있으며, 종속 변수의 다른 중요한 특징을 모델화할 수 있게 해준다(Cliff and Ord 1981, 203). 단일 변수에 대한 표준 테스트와 비교하기 위해 여기서는 절편만 포함된 회귀 모델을 사용하였으며, 그 결과가 동일함을 확인할 수 있다.

```{r}
#| eval: false
lm(I_turnout ~ 1, pol_pres15) |> 
    lm.morantest(listw = lw_q_B) |> 
    glance_htest()
# Observed Moran I      Expectation         Variance      Std deviate 
#         0.691434        -0.000401         0.000140        58.461349 
#          p.value 
#         0.000000
```

정규성과 랜덤화 가정 하에서의 검정 간 차이는 변수의 첨도가 정상 범위를 벗어나는 경우 추가 항목이 더해진다는 점이다. 이때 사용되는 척도는 고전적인 첨도 측정법이다. 디폴트인 랜덤화 가정 하에서는 결과가 크게 변화하지는 않는다.

```{r}
#| eval: false
(I_turnout |> 
    moran.test(listw = lw_q_B) -> mtr) |> 
    glance_htest()
# Moran I statistic       Expectation          Variance 
#          0.691434         -0.000401          0.000140 
#       Std deviate           p.value 
#         58.459835          0.000000
```

1970년대 초반부터 몬테카를로(Monte Carlo) 검정, 즉 호프(Hope) 유형의 검정 혹은 순열 부트스트랩으로 알려진 검정 절차에 대한 관심이 제기되었다. 기본적으로 `moran.mc` 함수는 `"htest"` 객체를 반환하지만, 내부적으로는 `boot::boot`을 사용하기 때문에 `return_boot=TRUE`로 설정하면 `"boot"` 객체를 반환할 수도 있다. 또한 시뮬레이션 횟수는 `nsim`으로 지정하는데, 이는 관측값들이 무작위로 섞이는 횟수를 나타낸다.

```{r}
#| eval: false
set.seed(1)
I_turnout |> 
    moran.mc(listw = lw_q_B, nsim = 999, 
             return_boot = TRUE) -> mmc
```

부트스트랩 순열은 각 무작위 순열의 결과를 보존하며, 통계량의 관측값(여기서는 모런 통계값)과 랜덤화 시뮬레이션의 평균값($E(I)$와 동일한 역할)의 차이, 그리고 램덤화 시뮬레이션의 표준 편차를 보고한다.

몬테카를로 시뮬레이션의 분산과 랜덤화 가정 하의 분석적 분산을 비교하면 보통 큰 차이가 없으며, 이는 몬테카를로 검정의 무용론을 주장할 근거가 된다.

```{r}
#| eval: false
c("Permutation bootstrap" = var(mmc$t), 
  "Analytical randomisation" = unname(mtr$estimate[3]))
#    Permutation bootstrap Analytical randomisation 
#                 0.000144                 0.000140
```

기어리의 전역적 통계량(Geary's $C$)는 `moran.test` 함수와 거의 동일한 아규먼트 구조를 따라 `geary.test` 함수로 구현되어 있다. 게티스-오드(Getis-Ord $G$) 테스트는 추가적인 아규먼트를 가지는데, 이는 Bivand와 Wong (2018)이 지적한 바처럼, 초기 통계량의 변종이 이후에 나타났고 주로 거리 기반 이웃 규정에서는 생성되는 무이웃 관측개체를 다루는 방식에서의 차이를 반영해야 하기 때문이다. Getis와 Ord(1992)의 194 페이지를 보면, $G^*$의 경우, $G$와는 달리 $i \neq j$ 합산 제약이 완화되어 $i$가 자기 자신을 이웃으로 포함할 수 있다(따라서 모든 관측개체가 적어도 하나의 이웃을 가지므로 무이웃 문제도 해결된다).

마지막으로, 경험적 베이즈 모런 통계량은 비율 데이터에서 공간적 자기상관을 평가할 때 분모를 고려할 수 있게 해준다(Assunção and Reis 1999). 지금까지 우리는 공간단위별로 유효 투표수와 투표권을 가진 인구수의 비율을 고려했으나, `EBImoran.mc` 함수를 사용하면 투표권을 가진 인구수가 적은 공간단위에서의 극단적인 비율값이 가지는 통계적 불확실성을 반영할 수 있게 된다. 그러나 결과에는 큰 영향이 없다.

지금까지 다룬 전역적 공간적 자기상관 통계량은 이웃 그래프에 기반한 공간 가중치를 활용한 측도들이다. 이러한 측도들을 매우 정교한 통계적 툴이라고 부르기는 어려울 것 같다. 왜냐하면 결과의 해석이 해당 변수에 대한 평균 모델을 어떻게 설정하느냐에 크게 의존하기 때문이다. 만약 평균 모델이 절편만을 가진 모델이라면, 전역적 통계량은 공간적 자기상관 뿐만 아니라 다른 모든 종류의 오지정 문제에 동시에 반응하게 된다(역자주: 공간적 자기상관 통계량이 측정하고 검정하는 것 속에는 다른 오지정 문제가 포함될 수 있기 때문에, 공간적 자기상관 통계량을 정교한 측도라고 평가할 수 없다는 의미이다). 공간단위의 선정과 관련된 개체화의 문제가 일반적으로는 오지정 문제의 핵심적인 원인이 된다.

## 국지적 측도

전역적 측도의 한계를 극복하기 위한 노력의 일환으로, 1990년대 초반부터 국지적 공간연관성 지표들이 등장하기 시작했다(Anselin 1995; Getis and Ord 1992, 1996).

또한, 모런 플롯을 통해 관심 변수와 관심 변수의 공간 지연값(spatially lagged values) 간의 관련성을 시각화할 수 있게 되었다. 일반적으로 행 표준화 가중치를 사용하면 축을 보다 더 직접적으로 비교할 수 있게 된다(Anselin 1996). `moran.plot` 함수는 또한 영향력 측정 객체(influence measures object)를 반환하는데, 전역적 모런 통계값을 나타내는 직선의 기울기에 상대적으로 큰 영향을 미치는 관측개체를 표시할 수 있게 해준다. 그림 15.1에서 높은 영향력을 미치는 관측개체가 상당히 많다는 점을 확인할 수 있다. 이러한 관측값과 공간지연 관측값의 쌍이 집합적으로 글로벌 측도를 구성하지만, 세부적으로도 탐색할 수 있다. 모런 플롯에서, 왼쪽 하단 사분면에는 낮은 값-낮은 값(low-low) 쌍이, 오른쪽 상단 사분면에는 높은 값-높은 값(high-high) 쌍이, 왼쪽 상단 사분면과 오른쪽 하단 사분면에는 낮은 값-높은 값(low-high) 및 높은 값-낮은 값(high-low) 쌍이 나타난다. 앞의 두 개의 사분면에 비해 상대적으로 적은 수가 포함되어 있다. `moran.plot` 함수에서 사분면은 변수값와 공간지연값의 평균을 기준으로 나뉘지만, 해당 값을 표준화한 경우라면 0을 기준으로 나뉘기도 한다.

![투표율에 대한 모런 플롯으로 행 표준화된 가중치가 사용되었다.](https://r-spatial.org/book/15-Measures_files/figure-html/fig-moranplot-1.png){#fig-15-1}

반환된 객체에서 회귀 영향 측정값(hat influence measure)을 추출하여 지도를 그리면(그림 15.2) 경계부에 위치한 공간단위들이 높은 값을 나타내는 것을 볼 수 있다(아마도 행표준화 공간가중치행렬을 적용했기 때문일 수도 있음)(역자주: 경계부의 공간단위는 상대적으로 적은 수의 이웃을 가지며, 행 표준화가 적용되었을 때 상대적으로 높은 가중치를 부여받게 된다.). 대도시 혹은 그 주변 지역에서도 높은 값을 관찰할 수 있다.

```{r}
#| eval: false
library(tmap)
# Breaking News: tmap 3.x is retiring. Please test v4, e.g. with
# remotes::install_github('r-tmap/tmap')
pol_pres15$hat_value <- infl_W$hat
tm_shape(pol_pres15) + tm_fill("hat_value")
```

![모런 회귀 영향 측도값의 분포로 행 표준화 행렬을 적용함.](https://r-spatial.org/book/15-Measures_files/figure-html/fig-moranhat-1.png){#fig-15-2}

### 국지적 모런 통계량

Bivand와 Wong(2018)은 국지적 모런 통계량(Moran's $I_i$)​과 국지적 게티스-오드 통계량(Getis-Ord $G_i$)​와 같은 국지적 지표 사용에 영향을 미치는 문제들을 다루었다. 일부 문제는 국지적 지표 계산에 영향을 미치며, 다른 문제는 해당 값의 통계적 추론에 영향을 미친다. $n$개의 관측단위에 대해 $n$개의 통계값이 산출되기 때문에, 다중 비교(multiple comparison) 문제를 해결할 필요가 있다. Caldas de Castro와 Singer(2006)는 전형적인 데이터셋과 시뮬레이션 실험을 바탕으로, 확률 값에 대한 오발견율(FDR, false discovery rate) 조정이 무조정의 결과보다 흥미로운 클러스터를 더 잘 보여줄 것이라고 결론지었다. 이를 바탕으로, Anselin(2019)은 FDR 조정을 재정의된 "유의성" 기준치(Benjamin et al., 2018)와 결합하는 방식을 제안했다. 예를 들어, 기존의 0.1, 0.05, 0.01 대신 0.01, 0.005, 0.001을 사용하는 방식이다. 또한 *유의적*(significant) 대신 *흥미로운*(interesting)이라는 용어를 사용할 것을 권고하였다. 이러한 논의는 Bivand(2022a)에서 더 자세히 다루어진다. 전역적 통계량과 마찬가지로, 오지정 문제는 여전히 혼란의 원인이 되며, 전역적 공간적 자기상관이 존재하는 상황에서 국지적 공간적 자기상관을 해석하는 것은 여전히 도전 과제이다(Ord and Getis 2001; Tiefelsdorf 2002; Bivand, Müller, and Reder 2009).

```{r}
#| eval: false
args(localmoran)
```

``` R
#  function (x, listw, zero.policy = NULL, na.action = na.fail,
#    conditional = TRUE, alternative = "two.sided", mlvar = TRUE,
#    spChk = NULL, adjust.x = FALSE)
```

Bivand와 Wong(2018)는 국지적 모런 통계량의 표준 편차에 대해 분석적 공식에 기반한 방식과 조건부 순열(permutation)에 기반한 방식을 비교한 바 있다. 이에 대해 Sauer et al.(2021)은 그러한 비교가 오해에 기반하고 있음을 명확히 보여주었다. Sokal, Oden, 그리고 Thomson(1998)은 총괄(total) 순열과 조건부 순열에 기반한 국지적 모런 통계량의 표준 편차 공식을 제시한 바 있는데, Bivand와 Wong(2018)에서 사용된 분석 공식은 이전의 관행에 기반하여 총괄 순열만 사용하며, 따라서 시뮬레이션 조건부 순열과 일치하지 않는다. 적시에 제안된 풀 리퀘스트 덕분에, 이제 `localmoran` 함수는 Sokal, Oden, 그리고 Thomson(1998)의 부록에 수록되어 있는 대안적 공식을 사용한 `conditional` 논리 아규먼트(디폴트는 `TRUE`)를 포함한다. `localmoran` 함수의 `mlvar`와 `adjust.x` 아규먼트가 필요한 이유는 Bivand와 Wong(2018)에 나타나 있으며, 다른 패키지의 결과와 비교할 수 있게 해준다. `"two.sided"` 확률 값을 디포트로 설정하여 다음과 같은 결과를 얻을 수 있다.

```{r}
#| eval: false
I_turnout |> 
    localmoran(listw = lw_q_W) -> locm
```

국지적 모런 통계량을 합산한 후 공간 가중치의 합으로 나누면 전역적 모런 통계량과 같아지며, 국지적 수준에서의 양 혹은 음의 공간적 자기상관의 존재를 확인할 수 있다.

```{r}
#| eval: false
all.equal(sum(locm[,1])/Szero(lw_q_W), 
          unname(moran.test(I_turnout, lw_q_W)$estimate[1]))
# [1] TRUE
```

`stats::p.adjust`를 사용하여 다중 비교를 조정한 결과, 조정을 적용하지 않을 경우 2,495개의 국지적 지표 중 15% 이상이 p-value \< 0.005를 가지는 것으로 나타났다. 그러나 전체 오류율(FWER, family-wise error rate)(역자주: 다중 가설 검정에서 최소한 하나의 개별 검정에서 제1종 오류가 발생할 확률을 의미하는데, 예를 들어 전체 오류률을 0.05로 하는 경우 개별 검정에서의 오류률은 반드시 0.05보다 적은 값이어야 함.)을 제어하기 위해 Bonferroni 조정을 사용할 경우 이는 1.5%로 감소한다. 두 가지 다른 옵션을 통한 조정도 가능한데, `"fdr"`은 Benjamini와 Hochberg(1995)의 허위 발견율(FDR) 조정 방법으로 약 6%를 나타내고, `"BY"`는 Benjamini와 Yekutieli(2001)의 또 다른 FDR 조정 방법으로 약 2.5%를 보였다.

```{r}
#| eval: false
pva <- function(pv) cbind("none" = pv, 
    "FDR" = p.adjust(pv, "fdr"), "BY" = p.adjust(pv, "BY"),
    "Bonferroni" = p.adjust(pv, "bonferroni"))
locm |> 
    subset(select = "Pr(z != E(Ii))", drop = TRUE) |> 
    pva() -> pvsp
f <- function(x) sum(x < 0.005)
apply(pvsp, 2, f)
#       none        FDR         BY Bonferroni 
#        385        149         64         38
```

전역적 측도에서는 분석적 방법을 대체할 수 있는 추론 방식으로 부트스트랩 순열을 사용할 수 있다. 그런데 분석적 분산 도출 방식과 순열 방식 모두 모든 관측값을 뒤섞는 것에 기반하고 있다. 국지적 측도에서는 조건부 순열이 사용되어야 하며, 이는 관측개체 $i$의 값을 고정한채로 나머지 $n-1$개의 값을 무작위로 샘플링하여 해당 이웃의 값을 결정하는 방식이다. 조건부 순열은 `localmoran_perm` 함수로 제공되며, 여러 컴퓨팅 노드가 있는 경우 병렬 샘플링이 가능하고, 각 컴퓨팅 노드에서 난수 생성기의 시드를 설정할 수도 있다. `nsim` 아규먼트로 시뮬레이션 수를 설정할 수 있는데, 시뮬레이션된 값 중 관측된 모런 통계값의 순위에 기반한 확률값 추정치의 정밀도를 결정한다.

```{r}
#| eval: false
library(parallel)
invisible(spdep::set.coresOption(max(detectCores()-1L, 1L)))
I_turnout |> 
    localmoran_perm(listw = lw_q_W, nsim = 9999, 
                    iseed = 1) -> locm_p
```

그 결과, 다중 비교 조정이 없는 경우 15% 이상의 관측값이 양측 p값이 0.005 미만으로 나타났고, Bonferroni 조정을 적용했을 때는 약 1.5%가 p값이 0.005 미만이었다. 여기서 p값은 순열 샘플의 표준 편차와 정규 분포를 사용하여 계산된 것이다.

```{r}
#| eval: false
locm_p |> 
    subset(select = "Pr(z != E(Ii))", drop = TRUE) |> 
    pva() -> pvsp
apply(pvsp, 2, f)
#       none        FDR         BY Bonferroni 
#        380        148         64         39
```

해당 변수가 반드시 정규 분포를 따른다고 가정할 수 없으므로, 모든 시뮬레이션 값 중에 관측값의 순위를 결정하고 그것에 기반하여 균등 분포에서의 확률 값을 계산하는 방식으로 p값을 구할 수도 있다.

```{r}
#| eval: false
locm_p |> 
    subset(select = "Pr(z != E(Ii)) Sim", drop = TRUE) |> 
    pva() -> pvsp
apply(pvsp, 2, f)
#       none        FDR         BY Bonferroni 
#        391        127          0          0
```

위의 결과는 `"BY"`와 본페로니 방식을 적용할 경우 9999개의 샘플의 경우에는 *흥미로운* 위치가 없다는 점을 말하고 있다. 하지만 샘플 수를 999999로 증가시킨다면 *흥미로운* 위치가 발견될 수 있다. FDR 조정과 흥미로운 컷오프 0.005를 적용하면 약 5%의 위치가 흥미로운 위치로 나타난다.

```{r}
#| eval: false
pol_pres15$locm_pv <- p.adjust(locm[, "Pr(z != E(Ii))"], "fdr")
pol_pres15$locm_std_pv <- p.adjust(locm_p[, "Pr(z != E(Ii))"], 
                                   "fdr")
pol_pres15$locm_p_pv <- p.adjust(locm_p[, "Pr(z != E(Ii)) Sim"],
                                 "fdr")
```

![국지적 모런 통계량의 FDR 유의확률 값. 왼쪽 상단 패널에는 분석적 조건부 유의확률이, 오른쪽 상단 패널에는 순열 표준 편차를 활용한 조건부 유의확률이, 왼쪽 하단 패널에는 순열 순위 조건부 유의확률이 나타나 있다. 투표율 데이터에 행 표준화 이웃이 적용되었다.](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localmoranPr-1.png){#fig-15-3}

FDR 조정과 흥미로운 위치 컷오프 0.005를 적용하여 진행한 결과, 그림 15.3에서 볼 수 있듯이 분석적 조건부 접근법, 순열 샘플링에서 샘플된 값들의 적률(moments)을 사용하는 접근법, 순열 샘플 내에서 관측 값의 순위를 사용하는 접근법 모두 비슷한 지도 패턴을 보여준다. 이는 입력 변수의 분포가 정규 분포에 매우 가깝기 때문에 발생한 것이다.

국지적 모런 통계치를 제시할 때는 종종 "핫스팟" 맵이 사용된다. 국지적 모런 통계값은 입력 변수의 값이 낮든 높든 강한 양의 자기상관을 보이기만 하면 높은 값을 가지므로, 유사한 값을 가지는 이웃들의 "클러스터"가 어디에서 발생하는지를 낮은 값의 클러스터와 높은 값의 클러스터를 구분하여 보여주는 것이 어렵다. 이를 해결하기 위해 모런 플롯을 사용할 수 있는데, 변수값과 공간 지체값의 평균을 기준으로 범주형 사분면 변수를 생성한다. 그런 다음, 기준 확률 값과 조정 과정에 의거해 모런 통계값이 "흥미로운" 값으로 간주되지 않으면 해당 개체의 사분면 범주값은 NA로 설정된다. 아래의 사례에서는 FDR 조정된 조건부 분석 확률 값이 사용되었는데(그림 15.3, 왼쪽 상단 패널), 53개의 관측치가 "Low-Low" 클러스터에, 96개의 관측치는 "High-High" 클러스터에 속한다. 이는 표준 편차 기반의 순열 p-값(그림 15.3, 오른쪽 상단 패널)에서도 비슷하지만, 순위 기반의 순열 p-값은 "High-High" 클러스터의 수가 줄고 "Low-Low" 클러스터의 군집 수가 증가한다(그림 15.3, 왼쪽 하단 패널).

```{r}
#| eval: false
quadr <- attr(locm, "quadr")$mean
a <- table(addNA(quadr))
locm |> hotspot(Prname="Pr(z != E(Ii))", cutoff = 0.005, 
                droplevels=FALSE) -> pol_pres15$hs_an_q
locm_p |> hotspot(Prname="Pr(z != E(Ii))", cutoff = 0.005, 
                  droplevels=FALSE) -> pol_pres15$hs_ac_q 
locm_p |> hotspot(Prname="Pr(z != E(Ii)) Sim", cutoff = 0.005,
                  droplevels = FALSE) -> pol_pres15$hs_cp_q
b <- table(addNA(pol_pres15$hs_an_q))
c <- table(addNA(pol_pres15$hs_ac_q))
d <- table(addNA(pol_pres15$hs_cp_q))
t(rbind("Moran plot quadrants" = a, "Analytical cond." = b, 
  "Permutation std. cond." = c, "Permutation rank cond." = d))
#           Moran plot quadrants Analytical cond.
# Low-Low                   1040               53
# High-Low                   264                0
# Low-High                   213                0
# High-High                  978               96
# <NA>                         0             2346
#           Permutation std. cond. Permutation rank cond.
# Low-Low                       53                     56
# High-Low                       0                      0
# Low-High                       0                      0
# High-High                     95                     71
# <NA>                        2347                   2368
```

```{r}
#| eval: false
pol_pres15$hs_an_q <- droplevels(pol_pres15$hs_an_q)
pol_pres15$hs_ac_q <- droplevels(pol_pres15$hs_ac_q)
pol_pres15$hs_cp_q <- droplevels(pol_pres15$hs_cp_q)
```

![국지적 모런 통계량의 FDR 조정 핫스팟 지도(유의수준은 0.005). 왼쪽 상단 패널에는 분석적 조건부 유의확률이, 오른쪽 상단 패널에는 순열 표준 편차를 활용한 조건부 유의확률이, 왼쪽 하단 패널에는 순열 순위 조건부 유의확률이 적용된 경우가 나타나 있다. 투표율 데이터에 행 표준화 이웃이 적용되었다.](https://r-spatial.org/book/15-Measures_files/figure-html/fig-Iihotspots-1.png){#fig-15-4}

Figure 15.4는 세 가지 접근 방식인 분석적 조건부 표준 편차, 순열 기반 표준 편차, 순위 기반 확률 값에 대해 $\alpha=0.005$ 확률 값 컷오프를 선택한 경우 FDR 조정된 *흥미로운* 클러스터들 사이에 거의 차이가 없음을 보여준다. "High-High" 클러스터의 핵심부는 대도시 지역이다.

Tiefelsdorf (2002)는 국지적 모런 통계량의 표준 편차 계산을 위한 표준 접근 방식에 수치적 추정치를 추가해야 한다고 주장하며, 안장점 근사를 통해 이 목표를 달성하는 것이 계산적으로 효율적인 방법임을 보여준다. `localmoran.sad` 함수는 첫 번째 아규먼트로 적합된 선형 모델을 받으므로, 우선 기본 모델(절편만 있는 모델)을 적합시켜야 한다. 그런데 유권자 수가 구역별로 매우 상이하므로 그것의 효과를 통제하기 위해 결국 가중 선형 모델을 적합시킨다.

```{r}
#| eval: false
lm(I_turnout ~ 1) -> lm_null
```

안장점 근사 방식은 조건부 순열만큼 계산이 많이 소요된다. 많은 샘플에 대해 단일한 측정값을 계산하는 대신, 각 국지적 근사에 대해 상당한 수치 계산이 필요하기 때문이다.

```{r}
#| eval: false
lm_null |> localmoran.sad(nb = nb_q, style = "W",
                                  alternative = "two.sided") |>
        summary() -> locm_sad_null
```

안장점 근사법의 주요 장점은 단순히 수치 변수를 사용하는 대신, 적합된 선형 모델을 사용하여 잔차를 분석한다는 점이다. 절편만 있는 모델을 사용하면 결과는 국지적 모런 통계량과 유사하지만, 관찰값에 가중치를 부여할 수 있다. 여기서는 투표권이 있는 사람의 수를 기준으로 가중치를 부여하며, 이를 통해 작은 단위의 관찰값은 낮은 가중치를 받게 된다.

```{r}
#| eval: false
lm(I_turnout ~ 1, weights = pol_pres15$I_entitled_to_vote) ->
        lm_null_weights
lm_null_weights |>
            localmoran.sad(nb = nb_q, style = "W",
                           alternative = "two.sided") |>
        summary() -> locm_sad_null_weights
```

다음으로, 농촌, 도시 및 기타 유형의 관찰 단위를 구분하는 범주형 변수를 추가한다.

```{r}
#| eval: false
lm(I_turnout ~ Types, weights=pol_pres15$I_entitled_to_vote) ->
        lm_types
lm_types |> localmoran.sad(nb = nb_q, style = "W",
                                  alternative = "two.sided") |>
        summary() -> locm_sad_types
```

```{r}
#| eval: false
locm_sad_null |> hotspot(Prname="Pr. (Sad)",
                     cutoff=0.005) -> pol_pres15$locm_sad0
locm_sad_null_weights |> hotspot(Prname="Pr. (Sad)",
                     cutoff = 0.005) -> pol_pres15$locm_sad1
locm_sad_types |> hotspot(Prname="Pr. (Sad)",
                     cutoff = 0.005) -> pol_pres15$locm_sad2
```

![국지적 모런 통계량의 FDR 조정 하스팟 클러스터 지도로 양측검정이고 흥미로운 컷오프값으로 0.005가 적용되었다. 왼쪽 상단 패널에는 순열 표준 편차를 활용한 조건부 유의확률이, 오른쪽 상단 패널에는 기본(절편만 있는) 모델의 안장점 근사에 근거한 유의확률이 , 왼쪽 하단 패널에는 가중 기본(절편만 있는) 모델의 안장점 근사에 근거한 유의확률이, 오른쪽 하단 패널에는 가중 유형 모델의 안장점 근사에 근거한 유의확률이 적용된 경우가 나타나 있다. 투표율 데이터에 행 표준화 이웃이 적용되었다.](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localmoranHsad-1.png){#fig-15-5}

```{r}
#| eval: false
rbind(null = append(table(addNA(pol_pres15$locm_sad0)),
                    c("Low-High" = 0), 1),
      weighted = append(table(addNA(pol_pres15$locm_sad1)),
                        c("Low-High" = 0), 1),
      type_weighted = append(table(addNA(pol_pres15$locm_sad2)),
                        c("Low-High" = 0), 1))
#               Low-Low Low-High High-High <NA>
# null               19        0        55 2421
# weighted            9        0        52 2434
# type_weighted      13        0        81 2401
```

그림 15.5의 왼쪽 상단 패널에는 비교의 목적으로 순열 순위 기반 클러스터가 제시되어 있다. 안장점 근사법은 더 풍부한 평균 모델을 사용할 수 있게 해주고, $i$에서의 회귀 잔차 값을 그 이웃들의 값과 연결시킨다는 의미에서 본질적으로 국지적인 근사법이기 때문에, 안정접 근사법에 기반한 나머지 세 개의 패널은 제법 다른 패턴을 보여주고 있다. 절편만 있는 (기본) 모델은 표준적 결과와 매우 유사하지만, 유권자 수에 따른 가중치 부여로 말미암아 대부분의 "Low-Low" 클러스터가 제거된 모습을 보인다. 범주형 유형 변수를 추가하면 도시의 "High-High" 클러스터가 강화되지만, 바르샤바 구역들은 흥미로운 군집 핵으로서 제외된다. 높은 투표율을 보인 바르샤바의 중앙 구역들은 마찬가지로 높은 투표율을 보이는 다른 구역들에 의해 둘러싸여 있는데, 이것은 공간적 자기상관에 기인한 것이 아니라 모두 대도시 구역들로 이루어졌기 때문이다. 또한, 전역적 공간 프로세스가 통합된 경우 안장점 근사법을 사용할 수 있는데, 이는 표준 접근 방식에서의 전역 및 지역 공간 자가 상관의 결합을 제거한다.

같은 결과를 정확 접근법을 사용하여 달성할 수도 있지만, 수치 적분이 실패할 수 있어 표준 편차의 정확한 추정값 대신 NaN을 반환하는 경우가 있을 수 있으므로 더 많은 조정이 필요할 수 있다(Bivand, Müller, and Reder 2009).

```{r}
#| eval: false
lm_types |> localmoran.exact(nb = nb_q, style = "W", 
    alternative = "two.sided", useTP=TRUE, truncErr=1e-8) |> 
    as.data.frame() -> locm_ex_types
```

```{r}
#| eval: false
locm_ex_types |> hotspot(Prname = "Pr. (exact)",
                         cutoff = 0.005) -> pol_pres15$locm_ex
```

![](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localmoranHsadex-1.png)

```{r}
#| eval: false
table(Saddlepoint = addNA(pol_pres15$locm_sad2),
      exact = addNA(pol_pres15$locm_ex))
#            exact
# Saddlepoint Low-Low High-High <NA>
#   Low-Low        13         0    0
#   High-High       0        81    0
#   <NA>            2         2 2397
```

### 국지적 게티스-오드 통계량

### 국지적 기어리 통계량

### rgeoda 패키지

## 연습문제
