---
date-modified: last-modified
number-sections: true
format: 
  html: 
    toc: true
code-link: true
code-copy: true
execute: 
  warning: false
  error: false
  freeze: auto
editor: visual
---

# 공간적 자기상관 측도 {#sec-autocorrelation}

에어리어 데이터 분석에서 공간적 자기상관이 존재하는 경우, 관측치의 독립성을 전제로 하는 전통적 추론 방식과는 다른 분석 절차가 요구된다는 점이 오래전부터 잘 알려져 왔다. 공간적 자기상관이 존재하면, 관측 개체 $i$의 값을 인접 이웃들의 집합 $N_i$에 속하는 다른 관측 개체 $j$의 값으로 예측할 수 있다. Moran(1948)과 Geary(1954)의 선구적인 연구 성과는 점진적인 수용 과정을 거쳐(사회과학 분야의 예: Duncan, Cuzzort, and Duncan 1961), 이후 정리와 확장을 통해 정량적 분석의 기본 도구로 자리 잡았다(Cliff and Ord 1973, 1981).

Cliff와 Ord(1973)는 조인 카운트 통계량, 모런 통계량(Moran's $I$), 기어리 통계량(Geary's $C$) 등 다양한 공간통계량에 공통적으로 적용 가능한 분포 이론을 확립하고자 하였으며, 이 과정에서 공간가중치행렬(spatial weights matrix)의 개념을 일반화하고 확장하는데 주력하였다. 이들 통계량은 전체 연구 지역에 대해 하나의 공간적 자기상관 값을 산출한다는 점에서 전역적 측도(global measure)라고 불리며, 이후 개별 구역 단위의 공간적 자기상관 값을 산출하는 국지적 측도(local measure)(Getis and Ord 1992; Anselin 1995)의 발전으로 이어졌다.

**spdep** 패키지는 다양한 측도를 계산할 수 있도록 할 뿐 아니라 측도간 비교 분석을 촉진하도록 설계되었다. 이러한 이유로 측도 함수는 컴파일된 코드가 아닌 R로 작성되어, 최근 소개된 **rgeoda** 패키지(Li and Anselin 2021; Anselin, Li, and Koschinsky 2021)보다 속도는 다소 느리지만 훨씬 더 유연하다.

## 측도와 프로세스 오지정

Tobler(1970)가 제시한 지리학의 제1법칙, 즉 “모든 것은 다른 모든 것과 연관되어 있다. 그러나 가까이 있는 것은 멀리 떨어져 있는 것보다 더 많이 연관되어 있다”는 만고의 진리처럼 받아들여져서는 안된다. 이 법칙은 지나치게 단순화된 개념으로, 다른 잠재적 문제들을 가려 버릴 수 있다. 예를 들어 개체화(entitation)의 문제, 스포트 문제, 그리고 오지정(misspecification)의 문제가 이에 해당한다. 관측 단위의 크기가 기저 공간 프로세스의 스케일에 부합하는가? 주어진 관측 단위에서 나타나는 관심 변수의 공간적 패턴이 다른 변수의 공간적 패턴으로 설명될 수 있는가?(역자주: 여기에서 '개체화'의 문제는 사용된 공간 단위가 해당 공간 현상을 분석하기에 적합한지와 관련된 문제로 소위 '공간단위 임의성의 문제(MAUP, modifiable areal unit problem)'와 관련된 것이다. '오지정'의 문제는 통계 모형에서 해당 현상을 설명하기에 적절하지 않은 방식으로 변수 설정이 이루어진 경우를 통칭하는 용어인데, 주로 주요 변수의 누락에서 비롯되는 문제를 지적한다.)

토블러(Tobler, 1970)의 논문은 올슨(Olsson, 1970)의 논문과 함께 경제지리학(*Economic Geography)* 저널의 특별호에 실렸다. 그러나 올슨은 공간적 자기상관이 공간 현상에 필연적으로 내재된 속성이 아니라, 부적절한 개체화, 누락된 변수, 그리고/또는 부적절하게 설정된 함수 관계로 인해 발생하는 경우가 더 많다는 점을 간파했다. Olsson의 핵심 인용문은 228쪽에 있다.

"이러한 자기상관의 존재는 Tobler(1970)가 말한 “모든 것은 다른 모든 것과 연관되어 있다. 그러나 가까이 있는 것은 멀리 떨어져 있는 것보다 더 많이 연관되어 있다”는 주장에 동의하고 싶어지게 만든다. 그러나 한편으로, 이러한 자기상관이 체계적인 오지정 오류를 가리고 있는 것처럼 보인다는 사실은 이 주장을 ‘지리학의 제1법칙’으로 격상하는 것이 다소 성급하다는 점을 시사한다. 최악의 경우, 이 주장은 사후 오류(post hoc fallacy, 단순한 우연을 인과 관계로 잘못 해석하는 오류)의 공간적 변형에 불과할 수도 있다."

제1법칙으로서의 '확고한 지위'는 존 스노(John Snow)가 지도를 통해 콜레라의 원인이 수인성임을 밝혀냈다는 '믿음'과 매우 유사하다. 존 스노의 이야기는 GIS를 홍보하는 데 도움이 될 수 있지만, 실제 역사적 사실과는 거리가 있다. 존 스노는 소호(Soho) 지역을 탐문하기 전에 이미 강력한 작업 가설을 갖고 있었으며, 해당 지도는 브로드 스트리트(Broad Street) 펌프가 차단된 이후 그의 가설이 옳았음을 문서화하기 위해 작성된 것이었다(Brody et al. 2000).

불행히도 공간적 자기상관 측도는 실제 공간 구조뿐 아니라, 모형화 과정에서의 잘못된 지정으로 인한 오류까지 반영할 수 있다(Schabenberger and Gotway 2005; McMillen 2003). 이를 이해하기 위해, 대표적인 공간적 자기상관 측도인 모런 통계량을 정의한 뒤(Cliff and Ord 1981, 17), 단순한 예시를 살펴보자.

$$
I=\frac {n\sum_{(2)}w_{ij} z_i z_j}{S_0\sum^n_{i=1}z^2_i}
$$

여기서 $z_i=x_i-\bar{x}$, $x_i$는 해당 변수의 $n$개의 관측값 중 하나, $\bar{x}=\sum^n_{i=1}x_i/n$, $\sum_{(2)}=\sum^n_{i=1}\sum^n_{j=1}(i\neq j)$, $w_{ij}$는 공간가중치, $S_0=\sum_{(2)}w_{ij}$이다. 먼저, 무작위 확률 변수에 대해 공간적 자기상관을 검토하기 위해 정규성 가정 하에서(인수를 `randomisation = FALSE`로 지정) 모런 검정을 수행한다. 검정 통계량은 $Z(I)=\frac{I-E(I)}{\sqrt{Var(I)}}$로 정의되며, 계산된 $z$ 값을 $E(I)$와 $Var(I)$를 갖는 정규분포와 비교한다. 아래는 무작위 확률 변수에 공간적 자기상관이 존재하지 않는다는 귀무가설을 검정한 결과이다.

```{r}
#| eval: false
library(spdep) |> suppressPackageStartupMessages()
library(parallel)
glance_htest <- function(ht) c(ht$estimate, 
    "Std deviate" = unname(ht$statistic), 
    "p.value" = unname(ht$p.value))
set.seed(1)
(pol_pres15 |> 
    nrow() |> 
    rnorm() -> x) |> 
    moran.test(lw_q_B, randomisation = FALSE,
               alternative = "two.sided") |> 
    glance_htest()
# Moran I statistic       Expectation          Variance 
#         -0.004772         -0.000401          0.000140 
#       Std deviate           p.value 
#         -0.369320          0.711889
```

이제, 약간의 공간적 경향성을 가진 가상의 변수를 생성하고, 이를 별도의 변수로 취급하지 않고 원래의 무작위 변수에 합산했다고 가정하자. 이 상태에서 동일한 검정을 적용하면 이번에는 강한 공간적 자기상관이 나타난다. 이는 공간적 경향성을 가진 변수를 모형에 포함하지 않아 발생한 변수 누락 오류로, 그 영향이 분석 결과에서 강한 공간적 자기상관으로 잘못 나타난 사례다.

```{r}
#| eval: false
beta <- 0.0015
coords |> 
    st_coordinates() |> 
    subset(select = 1, drop = TRUE) |> 
    (function(x) x/1000)() -> t
(x + beta * t -> x_t) |> 
    moran.test(lw_q_B, randomisation = FALSE,
               alternative = "two.sided") |> 
    glance_htest()
# Moran I statistic       Expectation          Variance 
#          0.043403         -0.000401          0.000140 
#       Std deviate           p.value 
#          3.701491          0.000214
```

공간적 경향성을 가진 변수를 선형모형의 독립변수로 포함하면, 잔차에서 공간적 자기상관이 사라지는 것을 확인할 수 있다.

```{r}
#| eval: false
lm(x_t ~ t) |> 
    lm.morantest(lw_q_B, alternative = "two.sided") |> 
    glance_htest()
# Observed Moran I      Expectation         Variance      Std deviate 
#        -0.004777        -0.000789         0.000140        -0.337306 
#          p.value 
#         0.735886
```

다양한 공간적 자기상관 측도는 여러 R 패키지에서 이용할 수 있다. 그 가운데 **spdep** 패키지(Bivand 2022b)가 핵심적인 역할을 담당하며, 패키지 간 차이는 주로 실행 설계와 관련된다(Bivand and Wong 2018). **spdep** 패키지를 사용하면 회귀 잔차에 대한 전역적 및 국지적 모런 검정을 수행할 수 있으며, 다른 패키지와 달리 정확(exact) 검정과 안장점 근사법(saddlepoint approximation)(Tiefelsdorf 2002; Bivand, Müller, and Reder 2009)을 모두 제공한다.

## 전역적 측도

### 범주 데이터를 위한 조인 카운트 통계량

먼저 조인 카운트(join-count) 통계량을 살펴보자. 여기서 `joincount.test()` 함수는 `"factor"` 값 벡터 `fx`와 `listw` 객체를 입력받아, **stats** 패키지에서 정의된 `htest`(가설 검정) 객체들의 리스트를 반환한다. 반환되는 각 `htest` 객체는 `fx` 인수의 각 수준에 대해 하나씩 생성된다. 관찰된 카운트는 동일한 범주 수준을 가진 이웃 쌍의 수를 의미하며, 이를 동일 컬러 조인(same-colour joins)이라고 한다.

```{r}
#| eval: false
args(joincount.test)
```

``` r
#  function (fx, listw, zero.policy = NULL, alternative = "greater",
#    sampling = "nonfree", spChk = NULL, adjust.n = TRUE)
```

이 함수는 가설 검정을 위한 `alternative` 인수와, 통계량의 분산을 구성하는 기준을 지정하는 `sampling` 인수를 입력받는다. 기본값 `"nonfree"`는 개념적으로 분석적 순열(analytical permutation)과 동일한 것이다.(역자주: ‘분석적 순열’은 난수를 사용해 무작위 순열을 생성하지 않고, 가능한 모든 순열의 조합과 그에 따른 검정 통계량 분포를 수학 공식이나 조합론(combinatorics)을 통해 직접 계산하는 방식이다. 즉, 가설 검정을 위한 적률(예: 기대값, 분산 등)을 산출하는 공식이 명시적으로 제시되는 방식이다.) `spChk` 인수는 이전 버전과의 호환성을 위해 유지된다. 참고로, 앞에서 살펴본 지방자치단체 데이터에 대한 범주 유형별 카운트는 다음과 같다.

```{r}
#| eval: false
(pol_pres15 |> 
        st_drop_geometry() |> 
        subset(select = types, drop = TRUE) -> Types) |> 
    table()
# 
#          Rural          Urban    Urban/rural Warsaw Borough 
#           1563            303            611             18
```

네 개의 범주 유형, 즉 네 개의 수준이 있으므로, `htest` 객체 리스트를 재배열하여 추정 결과를 나타내는 행렬을 생성한다. 관찰된 동일 컬러 조인 카운트는 입력된 범주 수준의 카운트를 기반으로 계산한 기대값과 함께 표로 정리된다. 예를 들어, 바르샤바 구역 간에는 결합이 거의 없을 것으로 예상되는데, 이는 구역 수가 매우 적기 때문이다. 분산 계산은 선택된 `listw` 객체의 기본 상수와 입력 범주 수준의 카운트를 사용하여 수행된다. $z$ 값은 관찰된 조인 카운트와 기대값의 차이를 분산의 제곱근으로 나누어 산출한다.

조인 카운트 검정은 다중 컬러조인 카운트 상황으로 확장되도록 수정되었다(Upton and Fingleton 1985). **spdep** 패키지에서는 `joincount.multi()` 함수로 구현되어 있으며, 비자유 샘플링(non-free sampling)을 기반으로 표를 반환하되 $p$ 값은 보고하지 않는다.(역자주: '자유 샘플링(free sampling)'은 각 공간 단위에 레이블(예: 흑과 백)을 독립적으로 무작위 부여하는 방식으로, 샘플링(즉, 재배치)마다 흑백 비율이 달라질 수 있어 복원 샘플링과 유사하다. 반면 '비자유 샘플링(nonfree sampling)'은 전체에서 흑과 백의 개수를 고정한 채로 무작위 재배치하는 방식으로, 원래 데이터의 비율을 유지하며 비복원 샘플링과 유사하다. 예를 들어 조인 카운트 통계량 검정에서 비자유 샘플링은 원래의 흑백 개수를 그대로 보존한 채 공간 단위의 위치만 바꾸는 방식이다.)

```{r}
#| eval: false
Types |> joincount.multi(listw = lw_q_B)
#                               Joincount Expected Variance z-value
# Rural:Rural                    3087.000 2793.920 1126.534    8.73
# Urban:Urban                     110.000  104.719   93.299    0.55
# Urban/rural:Urban/rural         656.000  426.526  331.759   12.60
# Warsaw Borough:Warsaw Borough    41.000    0.350    0.347   68.96
# Urban:Rural                     668.000 1083.941  708.209  -15.63
# Urban/rural:Rural              2359.000 2185.769 1267.131    4.87
# Urban/rural:Urban               171.000  423.729  352.190  -13.47
# Warsaw Borough:Rural             12.000   64.393   46.460   -7.69
# Warsaw Borough:Urban              9.000   12.483   11.758   -1.02
# Warsaw Borough:Urban/rural        8.000   25.172   22.354   -3.63
# Jtot                           3227.000 3795.486 1496.398  -14.70
```

바이너리 가중치를 적용하는 상항에서는 조인 카운트의 합에 해당 조인에 대한 가중치를 곱한 값도 여전히 정수로 나타난다. 그러나 행표준화가중치를 적용하면, 가중치가 대부분 1보다 작은 분수가 되므로 카운트, 기대값, 분산이 달라진다. 그럼에도 최종적인 $z$ 값에는 큰 변화가 없다.

그러나 역거리 기반의 `listw` 객체를 사용하면 $z$ 값이 크게 변한다. 이는 가까운 센트로이드에 상대적으로 더 큰 가중치가 부여되기 때문이다.

```{r}
#| eval: false
Types |> joincount.multi(listw = lw_d183_idw_B)
#                               Joincount Expected Variance z-value
# Rural:Rural                    3.46e+02 3.61e+02 4.93e+01   -2.10
# Urban:Urban                    2.90e+01 1.35e+01 2.23e+00   10.39
# Urban/rural:Urban/rural        4.65e+01 5.51e+01 9.61e+00   -2.79
# Warsaw Borough:Warsaw Borough  1.68e+01 4.53e-02 6.61e-03  206.38
# Urban:Rural                    2.02e+02 1.40e+02 2.36e+01   12.73
# Urban/rural:Rural              2.25e+02 2.83e+02 3.59e+01   -9.59
# Urban/rural:Urban              3.65e+01 5.48e+01 8.86e+00   -6.14
# Warsaw Borough:Rural           5.65e+00 8.33e+00 1.73e+00   -2.04
# Warsaw Borough:Urban           9.18e+00 1.61e+00 2.54e-01   15.01
# Warsaw Borough:Urban/rural     3.27e+00 3.25e+00 5.52e-01    0.02
# Jtot                           4.82e+02 4.91e+02 4.16e+01   -1.38
```

### 모런 통계량

**spdep** 패키지에서 모런 통계량은 `moran.test()` 함수로 구현되어 있다. 이 함수는 `joincount.test()` 함수와 유사한 인수를 가지지만, 샘플링 대신 랜덤화(randomisation) 가정을 토대로 측도의 분산을 계산한다. 또한 수치 값 대신 순위를 사용할 수도 있다(Cliff and Ord 1981, 46). 일부 오래된 소프트웨어에서는 분산 항목의 마지막 구성 요소가 생략된 채 표시되는데, `drop.EI2` 인수는 이를 재현해준다.(역자주: 모런 통계량과 기어리 통계량의 가설 검정에는 전통적으로 두 가지 접근법이 있다. ‘랜덤화 가정’은 관측값을 공간단위에 무작위로 재배치하여 경험적 분포를 구성하는 방식으로, 전체 레이블 비율을 유지하는 비자유 샘플링과 유사하다. 반면 ‘정규성(normality) 가정’은 관측값이 정규분포를 따른다고 가정하여 이론적 분포를 이용하는 방식으로, 자유 샘플링과 유사하다. 두 접근법은 기대값은 동일하지만 분산이 서로 다르며, 모두 적률(moment)에 대한 공식을 제시하는 분석적 순열 방식이다.)

```{r}
#| eval: false
args(moran.test)
```

``` r
#  function (x, listw, randomisation = TRUE, zero.policy = NULL,
#    alternative = "greater", rank = FALSE, na.action = na.fail,
#    spChk = NULL, adjust.n = TRUE, drop.EI2 = FALSE)
```

`randomisation` 인수의 기본값은 `TRUE`이며, `FALSE`로 지정하면 정규성 가정 하에서 검정을 수행한다. 아래 사례를 통해, 단일 변수에 정규성 가정을 적용한 검정 결과와 절편만 포함된 회귀모형의 잔차에 대해 랜덤화 가정 하에서 수행한 검정 결과가 동일하게 나타남을 확인할 수 있다. 해당 변수는 2015년 폴란드 대통령 선거의 투표율이다. `randomisation`의 철자는 Cliff와 Ord(1973)의 표기를 따른 것이다.

```{r}
#| eval: false
pol_pres15 |> 
        st_drop_geometry() |> 
        subset(select = I_turnout, drop = TRUE) -> I_turnout
```

```{r}
#| eval: false
I_turnout |> moran.test(listw = lw_q_B, randomisation = FALSE) |> 
    glance_htest()
# Moran I statistic       Expectation          Variance 
#          0.691434         -0.000401          0.000140 
#       Std deviate           p.value 
#         58.461349          0.000000
```

`lm.morantest()` 함수는 `resfun` 인수를 가지고 있는데, 이를 통해 검정에 사용할 잔차를 추출하는 함수를 지정할 수 있다. 이를 활용하면 종속 변수의 다른 중요한 특성을 모형화할 수 있다(Cliff and Ord 1981, 203). 단일 변수에 대한 표준 검정과 비교하기 위해, 여기서는 절편만 포함된 회귀모형을 사용하였으며 그 결과가 동일함을 확인할 수 있다.

```{r}
#| eval: false
lm(I_turnout ~ 1, pol_pres15) |> 
    lm.morantest(listw = lw_q_B) |> 
    glance_htest()
# Observed Moran I      Expectation         Variance      Std deviate 
#         0.691434        -0.000401         0.000140        58.461349 
#          p.value 
#         0.000000
```

정규성 가정과 랜덤화 가정 하에서의 검정 차이는, 변수의 첨도가 정상 범위를 벗어나는 경우 추가 항목이 더해진다는 점이다. 이때 사용되는 척도는 고전적인 첨도 측정법이다. 기본값인 랜덤화 가정 하에서는 결과가 크게 달라지지 않는다.

```{r}
#| eval: false
(I_turnout |> 
    moran.test(listw = lw_q_B) -> mtr) |> 
    glance_htest()
# Moran I statistic       Expectation          Variance 
#          0.691434         -0.000401          0.000140 
#       Std deviate           p.value 
#         58.459835          0.000000
```

1970년대 초반부터 몬테카를로(Monte Carlo) 검정, 즉 호프(Hope) 유형의 검정 또는 순열 부트스트랩(permutation bootstrap)으로 알려진 검정 절차에 대한 관심이 제기되었다. 기본적으로 `moran.mc()` 함수는 `"htest"` 객체를 반환하지만, 내부적으로는 `boot::boot()` 함수를 사용하므로 `return_boot = TRUE`로 설정하면 `"boot"` 객체를 반환할 수도 있다. 또한 시뮬레이션 횟수는 `nsim`으로 지정하며, 이는 관측값을 무작위로 섞는 횟수를 의미한다.(역자주: 몬테카를로 검정 또는 순열 부트스트랩 검정은 가능한 모든 순열을 실제로 계산하지 않고, 그중 일부를 난수로 무작위 추출하여 검정 통계량의 분포를 근사하는 방식이다. 추출 횟수가 충분히 많을수록 근사 정확도가 높아지지만, 결과는 난수 생성에 따라 변동할 수 있다. 이에 비해 위에서 살펴본 분석적 순열은 적률(기대값, 분산 등)을 수학적 공식으로 직접 계산하여 검정 통계량의 분포를 구하는 방식으로, 난수 추출이 필요 없으며 동일한 데이터와 가정하에서는 언제나 같은 결과를 얻는다.)

```{r}
#| eval: false
set.seed(1)
I_turnout |> 
    moran.mc(listw = lw_q_B, nsim = 999, 
             return_boot = TRUE) -> mmc
```

순열 부트스트랩은 각 무작위 순열의 결과를 보존하며, 통계량의 관측값(여기서는 모런 통계값)과 랜덤화 시뮬레이션의 평균값($E(I)$와 동일한 역할)의 차이, 그리고 램덤화 시뮬레이션의 표준편차를 보고한다.

몬테카를로 시뮬레이션의 분산과 랜덤화 가정 하에서의 분석적 분산을 비교하면, 보통 큰 차이가 없다. 이는 몬테카를로 검정이 불필요하다는 주장의 근거가 된다.

```{r}
#| eval: false
c("Permutation bootstrap" = var(mmc$t), 
  "Analytical randomisation" = unname(mtr$estimate[3]))
#    Permutation bootstrap Analytical randomisation 
#                 0.000144                 0.000140
```

전역적 기어리 통계량(Geary's $C$)은 `geary.test()` 함수로 구현되어 있으며, `moran.test()` 함수와 거의 동일한 인수 구조를 따른다. 게티스-오드(Getis-Ord $G$) 검정은 추가적인 인수를 가지는데, 이는 Bivand와 Wong(2018)이 지적한 바와 같이 초기 통계량의 변종이 이후에 나타났고, 특히 거리 기반 이웃 규정에서는 생성되는 무이웃 관측 개체를 처리하는 방식의 차이를 반영해야 하기 때문이다. Getis와 Ord(1992)의 194쪽에 따르면, $G^*$의 경우, $G$와는 달리 $i \neq j$ 합산 제약이 완화되어 $i$가 자기 자신을 이웃에 포함할 수 있다. 이렇게 하면 모든 관측 개체가 적어도 하나의 이웃을 가지게 되므로 무이웃 문제도 해결된다.

마지막으로, 경험적 베이즈 모런 통계량은 비율 데이터에서 공간적 자기상관을 평가할 때 분모를 고려할 수 있게 해준다(Assunção and Reis 1999). 지금까지는 공간단위별로 유효 투표수와 투표권을 가진 인구수의 비율을 고려했으나, `EBImoran.mc()` 함수를 이용하면 투표권을 가진 인구수가 적은 공간단위에서 나타나는 극단적인 비율값이 가지는 통계적 불확실성을 반영할 수 있다. 그러나 결과에는 큰 변화가 없다.

지금까지 다룬 전역적 공간적 자기상관 통계량은 이웃 그래프에 기반한 공간가중치를 활용한 측도들이다. 이러한 측도들을 매우 정교한 통계적 도구라고 부르기는 어렵다. 그 이유는 결과의 해석이 해당 변수의 평균 모형을 어떻게 설정하느냐에 크게 의존하기 때문이다. 만약 평균 모형이 절편만 포함한다면, 전역적 통계량은 공간적 자기상관 뿐만 아니라 다른 모든 종류의 오지정 문제에도 동시에 반응하게 된다. 공간단위의 선정과 관련된 개체화 문제가 일반적으로는 오지정 문제의 핵심적인 원인이 된다.(역자주: 공간적 자기상관 통계량이 측정하고 검정하는 대상에는 현상의 본질적인 공간적 자기상관성뿐 아니라, 측정 과정에서 비롯되는 기타 요인이나 오지정 문제가 함께 반영될 수 있다. 따라서 이러한 통계량을 현상의 공간적 자기상관성을 정밀하게 측정하는 척도로 단정하기는 어렵다는 의미이다.)

## 국지적 측도

전역적 측도의 한계를 극복하기 위한 노력의 일환으로, 1990년대 초반부터 '국지적 공간연관성 지표(LISA, local indicators of spatial association)'들이 등장하기 시작했다(Anselin 1995; Getis and Ord 1992, 1996).

또한, 모런 플롯(혹은 모런 산포도)을 통해 관심 변수와 그 공간래그값(14장 참조) 간의 관련성을 시각화할 수 있게 되었다. 일반적으로 행표준화가중치를 사용하면 두 축을 보다 더 직접적으로 비교할 수 있다(Anselin 1996). `moran.plot()` 함수는 영향력 측정 객체(influence measures object)를 반환하며, 이를 통해 전역적 모런 통계량을 나타내는 직선의 기울기에 상대적으로 큰 영향을 미치는 관측 개체를 표시할 수 있다.(역자주: '영향력 측정 객체'는 회귀분석 등에서 각 관측 개체가 분석 결과에 미치는 영향을 정량화한 지표들의 집합을 담는 결과 객체를 말한다. 여기에는 레버리지(leverage), Cook’s 거리, DFBETA, DFFITS, 공분산 비율 등과 같이 특정 관측 개체를 제거하거나 변경했을 때 추정치나 적합값이 얼마나 변하는지를 나타내는 통계량이 포함된다. `moran.plot()` 함수는 Moran 산점도를 작성하면서 이러한 영향력 측정 절차를 표준화된 관측값과 공간래그값 간의 관계에 적용하여, 각 공간단위가 국지적 모런 통계량에 미치는 상대적 영향을 파악할 수 있는 형태로 반환한다.) 그림 15.1에서는 영향력이 큰 관측 개체가 상당히 많다는 점을 확인할 수 있다. 이러한 관측값과 공간래그 관측값의 쌍은 집합적으로 전역적 측도를 구성하지만, 개별적으로도 탐색이 가능하다. 모런 플롯에서 오른쪽 상단 사분면에는 높은 값-높은 값(H-H) 쌍이, 왼쪽 하단 사분면에는 낮은 값-낮은 값(L-L) 쌍이 나타난다. 왼쪽 상단과 오른쪽 하단 사분면에는 각각 낮은 값-높은 값(L-H)과 높은 값-낮은 값(H-L) 쌍이 위치하며, 앞의 두 사분면에 비해 상대적으로 적게 나타난다. `moran.plot()` 함수에서 사분면은 변수값와 공간래그값의 평균을 기준으로 나뉘지만, 해당 값을 표준화한 경우에는 0을 기준으로 나뉜다.

![투표율에 대한 모런 플롯(행표준화 공간가중치행렬 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-moranplot-1.png){#fig-15-1}

반환된 객체에서 회귀 영향 측도값(구체적으로는 hat influence measure, 햇 영향력 지표 혹은 레버리지 값)을 추출하여 지도를 작성하면(그림 15.2), 경계부에 위치한 공간단위들이 높은 값을 나타내는 것을 확인할 수 있다. 이는 아마도 행표준화 공간가중치행렬을 적용했기 때문일 수 있다.(역자주: 경계부의 공간단위는 상대적으로 적은 수의 이웃을 가지며, 행 표준화가 적용되었을 때 상대적으로 높은 가중치를 부여받게 된다.) 대도시나 그 주변 지역에서도 높은 값을 관찰할 수 있다.

```{r}
#| eval: false
library(tmap)
# Breaking News: tmap 3.x is retiring. Please test v4, e.g. with
# remotes::install_github('r-tmap/tmap')
pol_pres15$hat_value <- infl_W$hat
tm_shape(pol_pres15) + tm_fill("hat_value")
```

![모런 회귀 영향 측도값의 분포(행표준화 공간가중치행렬 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-moranhat-1.png){#fig-15-2}

### 국지적 모런 통계량

Bivand와 Wong(2018)은 국지적 모런 통계량(Moran's $I_i$)​과 국지적 게티스-오드 통계량(Getis-Ord $G_i$)​과 같은 국지적 지표 사용에 영향을 미치는 문제들을 다루었다. 일부 문제는 국지적 지표 계산에 영향을 미치고, 다른 문제는 해당 값에 대한 통계적 추론에 영향을 준다. $n$개의 관측 단위에 대해 $n$개의 통계값이 산출되므로, 다중비교(multiple comparison) 문제를 해결할 필요가 있다.(역자주: '다중비교 문제'란 여러 가설 검정을 동시에 수행할 때 우연에 의해 ‘유의’로 판정되는 결과가 증가하는 현상이다. 예를 들어, 유의수준 0.05에서 독립된 검정을 5번 수행하면, 모두 유의하지 않을 확률은 $0.95^5\approx 0.77$이고, 따라서 최소 한 번이라도 유의할 확률은 약 22.6%에 달한다. 국지적 통계량처럼 관측 개체마다 개별 검정을 수행하는 경우, 이러한 오류를 통제하기 위해 Bonferroni 보정이나 뒤에서 다룰 FDR과 같은 조정 방법이 필요하다.) Caldas de Castro와 Singer(2006)는 전형적인 데이터셋과 시뮬레이션 실험을 바탕으로, 확률값에 대한 FDR(false discovery rate, 오발견율) 조정이 무조정의 결과보다 흥미로운 클러스터를 더 잘 드러낸다고 결론지었다. 이를 바탕으로, Anselin(2019)은 FDR 조정을 재정의된 ‘유의성‘ 기준치(Benjamin et al., 2018)와 결합하는 방식을 제안하였다. 예를 들어, 기존의 0.1, 0.05, 0.01 대신 0.01, 0.005, 0.001을 사용하는 방식이다. 또한 *유의적*(significant) 대신 *흥미로운*(interesting)이라는 용어 사용을 권고하였다. 이러한 논의는 Bivand(2022a)에서 더 자세히 다루어진다. 전역적 통계량과 마찬가지로, 오지정 문제는 여전히 혼란의 원인이며, 전역적 공간적 자기상관이 존재하는 상황에서 국지적 공간적 자기상관을 해석하는 일은 여전히 도전 과제이다(Ord and Getis 2001; Tiefelsdorf 2002; Bivand, Müller, and Reder 2009).

```{r}
#| eval: false
args(localmoran)
```

``` r
#  function (x, listw, zero.policy = NULL, na.action = na.fail,
#    conditional = TRUE, alternative = "two.sided", mlvar = TRUE,
#    spChk = NULL, adjust.x = FALSE)
```

Bivand와 Wong(2018)는 국지적 모런 통계량의 표준편차를 분석적 공식에 기반한 방식과 조건부(conditional) 순열에 기반한 방식으로 비교하였다. 이에 대해 Sauer 등(2021)은 이러한 비교가 오해에 기반하고 있음을 명확히 보여주었다. Sokal, Oden과 Thomson(1998)은 총괄(total) 순열과 조건부 순열에 기반한 국지적 모런 통계량의 표준편차 공식을 제시한 바 있는데, Bivand와 Wong(2018)에서 사용된 분석 공식은 이전 관행에 따라 총괄 순열만 사용하였으며, 따라서 시뮬레이션 조건부 순열과 일치하지 않는다.(역자주: 국지적 공간적 자기상관 측도의 맥락에서 '총괄 혹은 총체적 순열'은 데이터의 모든 값을 대상으로 무작위 재배치를 수행하는 방식이다. 반면 '조건부 혹은 조건적 순열'은 특정 관측 단위의 값을 고정한 채 나머지 값만 무작위로 재배치한다. 두 방식 모두 랜덤화 가정에 기반하며, 적률(기대값, 분산 등)을 공식을 구하는 분석적 순열로도, 난수 시뮬레이션에 의한 순열 부트스트랩으로도 구현할 수 있다.) 적시에 제안된 풀 리퀘스트 덕분에, 이제 `localmoran()` 함수는 Sokal, Oden과 Thomson(1998)의 부록에 수록된 대안적 공식을 사용한 `conditional` 논리 인수(기본값은 `TRUE`)를 포함한다. `localmoran()` 함수의 `mlvar`와 `adjust.x` 인수가 필요한 이유는 Bivand와 Wong(2018)에 설명되어 있으며, 이를 통한 다른 패키지의 결과와 비교할 수 있다. 기본값인 `two.sided`를 설정하면 다음과 같은 결과를 얻을 수 있다.

```{r}
#| eval: false
I_turnout |> 
    localmoran(listw = lw_q_W) -> locm
```

국지적 모런 통계량을 합산한 뒤 공간가중치의 합으로 나누면 전역적 모런 통계량과 동일해지며, 이를 통해 국지적 수준에서 양 또는 음의 공간적 자기상관의 존재를 확인할 수 있다.

```{r}
#| eval: false
all.equal(sum(locm[,1])/Szero(lw_q_W), 
          unname(moran.test(I_turnout, lw_q_W)$estimate[1]))
# [1] TRUE
```

`stats::p.adjust()` 함수를 사용해 다중비교를 조정한 결과, 조정을 적용하지 않을 경우 2,495개의 국지적 지표 중 15% 이상이 $p\text{-value}<0.005$를 가지는 것으로 나타났다. 그러나 FWER(family-wise error rate, 전체 오류율)을 제어하기 위해 Bonferroni 조정을 사용할 경우 이 비율은 1.5%로 감소한다. 다른 두 가지 조정 옵션도사용 할 수 있는데, `"fdr"`은 Benjamini와 Hochberg(1995)의 FDR 조정 방법으로 약 6%를, `"BY"`는 Benjamini와 Yekutieli(2001)의 또 다른 FDR 조정 방법으로 약 2.5%를 보였다.(역자주: Bonferroni 조정은 전역적 유의확률을 $\alpha$라고 할 때, 국지적 측도에 대응하는 유의확률을 $\alpha/n$ 으로 계산하는 방법이다. 이에 비해 Benjamini와 Hochberg(1995)가 제안한 FDR 조정 방법은 여러 가설 검정에서 기각된 가설 중 실제로는 참인 비율을 제어하는 것을 목표로 하며, Bonferroni 조정보다 덜 보수적이어서 검정력이 높다. 이후 Benjamini와 Yekutieli(2001)는 BH 방법을 상관 구조가 존재하는 검정 상황에도 적용할 수 있도록 확장하였다.)

```{r}
#| eval: false
pva <- function(pv) cbind("none" = pv, 
    "FDR" = p.adjust(pv, "fdr"), "BY" = p.adjust(pv, "BY"),
    "Bonferroni" = p.adjust(pv, "bonferroni"))
locm |> 
    subset(select = "Pr(z != E(Ii))", drop = TRUE) |> 
    pva() -> pvsp
f <- function(x) sum(x < 0.005)
apply(pvsp, 2, f)
#       none        FDR         BY Bonferroni 
#        385        149         64         38
```

전역적 측도에서는 분석적 방법에 대한 대안적 추론 방식으로 순열 부트스트랩이 사용된다. 그런데 분석적 분산 도출 방식과 순열 방식 모두 모든 관측값을 뒤섞는 것에 기반한다. 국지적 측도에서는 전체 순열보다 조건부 순열이 훨씬 더 적합하다. 이는 관측 개체 $i$의 값을 고정한채 나머지 $n-1$개의 값을 무작위로 샘플링하여 해당 이웃의 값을 결정하는 방식이다. 조건부 순열은 `localmoran_perm()` 함수로 제공되며, 여러 컴퓨팅 노드가 있는 경우 병렬 샘플링이 가능하고, 각 컴퓨팅 노드에서 난수 생성기의 시드를 설정할 수 있다. `nsim` 인수로 시뮬레이션 수를 지정하면, 시뮬레이션된 값 중 관측된 모런 통계값의 순위에 기반하여 확률값 추정치의 정밀도가 결정된다.

```{r}
#| eval: false
library(parallel)
invisible(spdep::set.coresOption(max(detectCores()-1L, 1L)))
I_turnout |> 
    localmoran_perm(listw = lw_q_W, nsim = 9999, 
                    iseed = 1) -> locm_p
```

그 결과, 다중비교 조정을 적용하지 않는 경우 전체 관측값의 15% 이상이 양측 $p$ 값이 0.005 미만으로 나타났다. Bonferroni 조정을 적용하면 이 비율은 약 1.5%로 감소하였다. 여기서 $p$ 값은 순열 샘플의 표준편차와 정규분포를 사용하여 계산되었다.

```{r}
#| eval: false
locm_p |> 
    subset(select = "Pr(z != E(Ii))", drop = TRUE) |> 
    pva() -> pvsp
apply(pvsp, 2, f)
#       none        FDR         BY Bonferroni 
#        380        148         64         39
```

해당 변수가 반드시 정규분포를 따른다고 가정할 수 없으므로, 모든 시뮬레이션 값에서 관측값의 순위를 산정하고, 그 순위에 기반하여 균등분포에서의 확률값을 계산하는 방식으로 $p$ 값을 구할 수도 있다.(역자주: 시뮬레이션을 통해 얻은 통계값들 중에서 관측 통계값과 같거나 그보다 더 극단적인 값을 보이는 경우의 개수를 이용해 일종의 근사 유의확률을 계산한다. 예를 들어 유의수준 0.005까지 확인하려면 999회의 시뮬레이션이 필요한데, 이는 유의확률의 최소 단위가 $1/(999+1)=0.001$ 이기 때문이다.)

```{r}
#| eval: false
locm_p |> 
    subset(select = "Pr(z != E(Ii)) Sim", drop = TRUE) |> 
    pva() -> pvsp
apply(pvsp, 2, f)
#       none        FDR         BY Bonferroni 
#        391        127          0          0
```

위의 결과는 `"BY"` 방식과 Bonferroni 방식을 적용한 경우, 9,999개의 샘플에서는 *흥미로운* 위치가 전혀 나타나지 않음을 보여준다. 그러나 샘플 수를 999,999로 늘리면 *흥미로운* 위치가 발견될 수 있다. 한편, FDR 조정과 판정 기준값(cut-off) 0.005를 적용하면, 약 5%의 위치가 흥미로운 위치로 나타난다.

```{r}
#| eval: false
pol_pres15$locm_pv <- p.adjust(locm[, "Pr(z != E(Ii))"], "fdr")
pol_pres15$locm_std_pv <- p.adjust(locm_p[, "Pr(z != E(Ii))"], 
                                   "fdr")
pol_pres15$locm_p_pv <- p.adjust(locm_p[, "Pr(z != E(Ii)) Sim"],
                                 "fdr")
```

![국지적 모런 통계량의 FDR 유의확률 값. 왼쪽 상단 패널은 분석적 조건부 유의확률, 오른쪽 상단 패널은 순열 표준편차를 이용한 조건부 유의확률, 왼쪽 하단 패널은 순열 순위에 기반한 조건부 유의확률을 각각 나타낸다(행표준화 공간가중치행렬 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localmoranPr-1.png){#fig-15-3}

FDR 조정과 판정 기준값 0.005를 적용한 결과, 그림 15.3에서 볼 수 있듯이 분석적 조건부 접근법, 순열 샘플링에서 추출된 값들의 적률을 활용한 접근법, 순열 샘플링에서 관측값의 순위를 활용한 접근법 모두 유사한 지도 패턴을 나타냈다. 이는 입력 변수의 분포가 정규분포에 매우 근접하기 때문에 나타난 현상이다.

국지적 모런통계치를 제시할 때는 종종 '핫스팟' 지도가 사용된다. 그러나 국지적 모런통계값은 입력 변수의 값이 낮든 높든 강한 양의 자기상관만 있으면 높은 값을 가지므로, 유사한 값을 지닌 이웃들의 '클러스터'가 어디에서 발생하는지를 낮은 값 클러스터와 높은 값 클러스터로 명확히 구분해 보이기는 어렵다. 이를 보완하기 위해 모런 플롯을 활용할 수 있다. 모런 플롯에서는 변수값과 공간래그값의 평균을 기준으로 범주형 사분면 변수를 생성한다. 이후, 기준 유의확률과 조정 절차에 따라 모런 통계값이 '흥미로운' 값으로 간주되지 않는 관측 개체는 사분면 범주 속성에서 `NA`값을 갖게 된다. 아래 사례에서는 FDR 조정된 조건부 유의확률 값을 사용했는데(그림 15.3, 왼쪽 상단 패널), 53개의 관측 개체가 'L-L' 클러스터에, 96개는 'H-H' 클러스터에 속했다. 이는 표준편차 기반의 순열 $p$ 값(그림 15.3, 오른쪽 상단 패널)에서도 유사하게 나타난다. 순위 기반 순열 $p$ 값(그림 15.3, 왼쪽 하단 패널)에서는 'H-H' 클러스터의 수가 줄고 'L-L' 클러스터 수가 증가한다.

```{r}
#| eval: false
quadr <- attr(locm, "quadr")$mean
a <- table(addNA(quadr))
locm |> hotspot(Prname="Pr(z != E(Ii))", cutoff = 0.005, 
                droplevels=FALSE) -> pol_pres15$hs_an_q
locm_p |> hotspot(Prname="Pr(z != E(Ii))", cutoff = 0.005, 
                  droplevels=FALSE) -> pol_pres15$hs_ac_q 
locm_p |> hotspot(Prname="Pr(z != E(Ii)) Sim", cutoff = 0.005,
                  droplevels = FALSE) -> pol_pres15$hs_cp_q
b <- table(addNA(pol_pres15$hs_an_q))
c <- table(addNA(pol_pres15$hs_ac_q))
d <- table(addNA(pol_pres15$hs_cp_q))
t(rbind("Moran plot quadrants" = a, "Analytical cond." = b, 
  "Permutation std. cond." = c, "Permutation rank cond." = d))
#           Moran plot quadrants Analytical cond.
# Low-Low                   1040               53
# High-Low                   264                0
# Low-High                   213                0
# High-High                  978               96
# <NA>                         0             2346
#           Permutation std. cond. Permutation rank cond.
# Low-Low                       53                     56
# High-Low                       0                      0
# Low-High                       0                      0
# High-High                     95                     71
# <NA>                        2347                   2368
```

```{r}
#| eval: false
pol_pres15$hs_an_q <- droplevels(pol_pres15$hs_an_q)
pol_pres15$hs_ac_q <- droplevels(pol_pres15$hs_ac_q)
pol_pres15$hs_cp_q <- droplevels(pol_pres15$hs_cp_q)
```

![국지적 모런 통계량의 FDR 조정 핫스팟 지도(유의수준은 0.005). 왼쪽 상단 패널에는 분석적 조건부 유의확률, 오른쪽 상단 패널은 순열 표준편차 기반 조건부 유의확률, 왼쪽 하단 패널은 순열 순위 기반 조건부 유의확률이 적용된 경우를 보여준다.(행표준화 공간가중치행렬 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-Iihotspots-1.png){#fig-15-4}

Figure 15.4는 분석적 조건부 표준편차, 순열 기반 표준편차, 순위 기반 확률 값의 세 가지 접근법에 대해 $\alpha=0.005$ 확률 값 컷오프를 적용했을 때 FDR 조정된 *흥미로운* 클러스터들 간의 차이가 거의 없음을 보여준다. 'H-H' 클러스터의 핵심부는 대도시 지역에 위치한다.

Tiefelsdorf (2002)는 국지적 모런 통계량의 표준편차를 계산하는 표준 접근 방식에 수치적 추정치를 추가해야 한다고 주장하며, 이를 안장점 근사를 통해 구현하는 것이 계산적으로 효율적인 방법임을 보여주었다. `localmoran.sad()` 함수는 첫 번째 인수로 적합된 선형모형을 입력받으므로, 우선 절편만 포함된 기본 모형을 적합시켜야 한다. 그러나 구역별 유권자 수가 크게 다르므로, 이러한 효과를 통제하기 위해 최종적으로 가중 선형모형을 적합시킨다.

```{r}
#| eval: false
lm(I_turnout ~ 1) -> lm_null
```

안장점 근사 방식은 조건부 순열만큼 계산 비용이 많이 든다. 이는 많은 샘플에 대해 단일 측정값을 계산하는 것이 아니라, 각 국지적 근사마다 상당한 수치 계산이 필요하기 때문이다.

```{r}
#| eval: false
lm_null |> localmoran.sad(nb = nb_q, style = "W",
                                  alternative = "two.sided") |>
        summary() -> locm_sad_null
```

안장점 근사법의 주요 장점은 단순히 수치 변수를 사용하는 대신, 적합된 선형모형을 기반으로 잔차를 분석한다는 점이다. 절편만 포함된 모형을 사용하면 결과는 국지적 모런 통계량과 유사하지만, 관찰값에 가중치를 부여할 수 있다. 여기서는 투표권이 있는 인구수를 기준으로 가중치를 부여하며, 이를 통해 작은 단위의 관찰값은 낮은 가중치를 받는다.

```{r}
#| eval: false
lm(I_turnout ~ 1, weights = pol_pres15$I_entitled_to_vote) ->
        lm_null_weights
lm_null_weights |>
            localmoran.sad(nb = nb_q, style = "W",
                           alternative = "two.sided") |>
        summary() -> locm_sad_null_weights
```

다음으로, 농촌, 도시, 기타 유형의 관측 개체를 구분하는 범주형 변수를 추가한다.

```{r}
#| eval: false
lm(I_turnout ~ Types, weights=pol_pres15$I_entitled_to_vote) ->
        lm_types
lm_types |> localmoran.sad(nb = nb_q, style = "W",
                                  alternative = "two.sided") |>
        summary() -> locm_sad_types
```

```{r}
#| eval: false
locm_sad_null |> hotspot(Prname="Pr. (Sad)",
                     cutoff=0.005) -> pol_pres15$locm_sad0
locm_sad_null_weights |> hotspot(Prname="Pr. (Sad)",
                     cutoff = 0.005) -> pol_pres15$locm_sad1
locm_sad_types |> hotspot(Prname="Pr. (Sad)",
                     cutoff = 0.005) -> pol_pres15$locm_sad2
```

![국지적 모런 통계량의 FDR 조정 핫스팟 지도(양측검정, 흥미로움의 판정 기준값 0.005 적용). 왼쪽 상단 패널에는 순열 표준편차를 활용한 조건부 유의확률, 오른쪽 상단 패널은 기본(절편만 있는) 모형의 안장점 근사에 기반한 유의확률, 왼쪽 하단 패널은 가중 기본(절편만 있는) 모형의 안장점 근사에 근거한 유의확률, 오른쪽 하단 패널은 가중 유형 모형의 안장점 근사에 기반한 유의확률을 나타낸다.(행표준화 공간가중치행렬의 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localmoranHsad-1.png){#fig-15-5}

```{r}
#| eval: false
rbind(null = append(table(addNA(pol_pres15$locm_sad0)),
                    c("Low-High" = 0), 1),
      weighted = append(table(addNA(pol_pres15$locm_sad1)),
                        c("Low-High" = 0), 1),
      type_weighted = append(table(addNA(pol_pres15$locm_sad2)),
                        c("Low-High" = 0), 1))
#               Low-Low Low-High High-High <NA>
# null               19        0        55 2421
# weighted            9        0        52 2434
# type_weighted      13        0        81 2401
```

그림 15.5의 왼쪽 상단 패널에는 비교를 위해 순열 순위 기반 클러스터가 제시되어 있다. 안장점 근사법은 더 풍부한 평균모형을 적용할 수 있으며, 관측 개체 $i$에서의 회귀 잔차 값을 그 이웃들의 값과 연결하는 본질적으로 국지적인 접근법이기 때문에, 안정접 근사법에 기반한 나머지 세 개의 패널은 상당히 다른 패턴을 보여준다. 절편만 포함한 기본 모형은 표준적인 결과와 매우 유사하지만, 유권자수에 따른 가중치 부여로 인해 대부분의 'L-L' 클러스터가 제거된다. 범주형 유형 변수를 추가하면 도시 지역의 'H-H' 클러스터가 강화되지만, 바르샤바 구역들은 흥미로운 군집의 핵에서 제외된다. 바르샤바의 중앙 구역들은 높은 투표율을 보이며, 마찬가지로 높은 투표율을 보이는 다른 구역들에 의해 둘러싸여 있으나, 이는 공간적 자기상관에 의한 것이 아니라 모두 대도시 구역에 속하기 때문이다. 또한, 전역적 공간 프로세스를 통합한 경우 안장점 근사법을 활용할 수 있는데, 이를 통해 표준 접근법에서 나타나는 전역 및 지역 공간적 자기상관의 결합 효과를 제거할 수 있다.

같은 결과를 정확 접근법으로도 얻을 수 있지만, 수치적분이 실패하는 경우가 있어 표준편차의 정확한 추정값 대신 `NaN`가 반환될 수 있다. 따라서 추가적인 조정이 필요할 수 있다(Bivand, Müller, and Reder 2009).(역자주: ‘정확 접근법’은 검정 통계량의 분포를 평균과 분산만으로 추정하는 정규 근사나, 이를 개선한 안장점 근사와 달리, 필요한 모든 적률(moment)을 활용해 분포를 근사가 아닌 정확한 형태로 계산하는 방법이다. 이러한 접근은 정규성 가정과 관련되며, 계산 과정에서 상당한 전산 자원이 소요된다.)

```{r}
#| eval: false
lm_types |> localmoran.exact(nb = nb_q, style = "W", 
    alternative = "two.sided", useTP=TRUE, truncErr=1e-8) |> 
    as.data.frame() -> locm_ex_types
```

```{r}
#| eval: false
locm_ex_types |> hotspot(Prname = "Pr. (exact)",
                         cutoff = 0.005) -> pol_pres15$locm_ex
```

![국지적 모런 통계량의 FDR 조정 핫스팟 지도(양측검정, 흥미로움의 판정 기준값 0.005 적용). 왼쪽 패널에는 가중 유형 모형의 안장점 근사에 기반한 유의확률이, 오른쪽 패널은 가중 유형 모형의 정확 접근법에 기반한 유의확률이 제시되어 있다.(행표준화 공간가중치행렬의 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localmoranHsadex-1.png){#fig-15-6}

그림 15.6에서 볼 수 있듯이, 정확 접근법과 안장점 근사법은 동일한 회귀 잔차, 다중비교 조정 방식, 그리고 기준값 수준을 적용했을 때 거의 동일한 클러스터 분류 결과를 산출한다. 두 방법 간의 차이는, 아래에 나타난 것처럼, 정확 접근법이 4개의 추가적인 관측 개체를 흥미로운 사례로 탐지한다는 점이다.

```{r}
#| eval: false
table(Saddlepoint = addNA(pol_pres15$locm_sad2),
      exact = addNA(pol_pres15$locm_ex))
#            exact
# Saddlepoint Low-Low High-High <NA>
#   Low-Low        13         0    0
#   High-High       0        81    0
#   <NA>            2         2 2397
```

### 국지적 게티스-오드 통계량

국지적 게티스-오드 측도(Getis-Ord $G_i$)(Getis and Ord 1992, 1996)는 표준화된 값으로 산출된다. `include.self` 인수를 사용하여 이웃 객체에 자신을 포함하도록 설정하면 $G^*_i$ 측도값을 계산할 수 있다. `return_internals = TRUE`로 지정하면 관측값, 기대값, 그리고 이에 대한 분석적 분산값이 함께 반환된다.

```{r}
#| eval: false
I_turnout |> 
        localG(lw_q_W, return_internals = TRUE) -> locG
```

순열에 기반한 가설 검정도 수행할 수 있다.

```{r}
#| eval: false
I_turnout |> 
        localG_perm(lw_q_W, nsim = 9999, iseed = 1) -> locG_p
```

분석적 표준편차에 기반한 유의확률, 순열 기반 표준편차에 기반한 유의확률(첫 번째 두 열과 행), 순열 순위 기반 유의확률 간의 상관관계는 매우 강하다.

```{r}
#| eval: false
cor(cbind(localG=attr(locG, "internals")[, "Pr(z != E(Gi))"], 
    attr(locG_p, "internals")[, c("Pr(z != E(Gi))", 
                                  "Pr(z != E(Gi)) Sim")]))
#                    localG Pr(z != E(Gi)) Pr(z != E(Gi)) Sim
# localG                  1              1                  1
# Pr(z != E(Gi))          1              1                  1
# Pr(z != E(Gi)) Sim      1              1                  1
```

### 국지적 기어리 통계량

Anselin(2019)의 연구는 Anselin(1995)의 내용을 확장한 것으로, 조사이아 패리(Josiah Parry)의 기여(풀 리퀘스트: <https://github.com/r-spatial/spdep/pull/66>) 덕분에 최근 **spdep** 패키지에 추가되었다. 이로써 $I_i$와 $G_i$에 사용되던 조건부 순열 프레임워크를 국지적 기어리 통계량($C_i$)에도 적용할 수 있게 되었다.

```{r}
#| eval: false
I_turnout |> 
        localC_perm(lw_q_W, nsim=9999, iseed=1) -> locC_p
```

순열 표준편차 기반 유의확률과 순위 기반 유의확률 값은 $G_i$와 비교했을 때 상관관계가 그리 높지 않다. 이는 부분적으로 $C_i$가 값들의 유사성을 값들의 곱이 아니라 값들 간의 차이 함수로 표현하기 때문이며, 이러한 공간적 자기상관 개념화 차이가 반영된 결과로 해석된다.

```{r}
#| eval: false
cor(attr(locC_p, "pseudo-p")[, c("Pr(z != E(Ci))",
                                 "Pr(z != E(Ci)) Sim")])
#                    Pr(z != E(Ci)) Pr(z != E(Ci)) Sim
# Pr(z != E(Ci))              1.000              0.966
# Pr(z != E(Ci)) Sim          0.966              1.000
```

```{r}
#| eval: false
locC_p |> hotspot(Prname = "Pr(z != E(Ci)) Sim",
                  cutoff = 0.005) -> pol_pres15$hs_C
locG_p |> hotspot(Prname = "Pr(z != E(Gi)) Sim",
                  cutoff = 0.005) -> pol_pres15$hs_G
```

![FDR 조정 핫스팟 지도(양측검정, 흥미로움의 판정 기준값 0.005 적용). 왼쪽 패널은 국지적 모런 통계량에 따른 공간 클러스터를, 가운데 패널은 국지적 게티스-오드 통계량에 따른 공간 클러스터를, 오른편 패널은 국지적 기어리 통계량에 따른 공간 클러스터를 보여준다.(행표준화 공간가중치행렬의 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localIGC-1.png){#fig-15-7}

그림 15.7은 동일한 변수(투표율)와 동일한 공간가중치를 사용했을 때 $I_i$, $G_i$, $C_i$가 식별한 흥미로운 클러스터 핵심부가 매우 유사함을 보여준다. 통계적 추론에는 순위 기반 순열 FDR 조정 확률값이 사용되었고, 기준값은 $\alpha=0.005$로 설정되었다. 대부분의 경우, `"High-High"` 클러스터의 핵심은 도시 지역이며, `"Low-Low"` 클러스터의 핵심은 북부의 인구 밀도가 낮은 농촌 지역과 남부 국경 근처의 독일 소수 민족 지역이다. 세 가지 측도는 클러스터 핵심을 명명하는 방식에서 약간 차이를 보인다. $I_i$는 모런 산점도 플롯의 사분면을 사용하고, $G_i$는 입력 변수의 평균을 기준으로 `"Low"`와 `"High"`를 구분하며(이는 $I_i$ 튜플의 첫 번째 요소와 동일), $C_i$는 입력 변수의 평균값 기준으로 하지만 공간래그값에 대해서는 0을 기준으로 나눈다. 이전과 마찬가지로 해당 사례가 없는 클러스터 범주는 제외된다.

비교를 위해, 다변량 $C_i$를 살펴보기 전에 두 번째(최종) 라운드 투표율에 대한 단변량 $C_i$를 먼저 살펴보자. 1차 투표에서 상위 두 후보 간의 결선 투표는, 1차 투표에서 명확한 선호를 보이지 않았던 일부 유권자의 참여를 유도할 수 있지만, 1차 투표에서 탈락한 후보에게 강한 충성심을 가졌던 일부 유권자의 참여를 저해할 수도 있다.

```{r}
#| eval: false
pol_pres15 |> 
        st_drop_geometry() |> 
        subset(select = II_turnout) |> 
        localC_perm(lw_q_W, nsim=9999, iseed=1) -> locC_p_II
```

```{r}
#| eval: false
locC_p_II |> hotspot(Prname = "Pr(z != E(Ci)) Sim",
                     cutoff = 0.005) -> pol_pres15$hs_C_II
```

다변량 $C_i$(Anselin 2019)는 단변량 $C_i$가값들의 합을 변수 개수로 나누어 계산하며, 이때 순열은 고정되어 변수 간 상관관계가 변하지 않도록 한다.

```{r}
#| eval: false
pol_pres15 |> 
        st_drop_geometry() |> 
        subset(select = c(I_turnout, II_turnout)) |>
        localC_perm(lw_q_W, nsim=9999, iseed=1) -> locMvC_p
```

다변량 $C_i$는 단변량 $C_i$의 평균값임을 다음과 같이 확인할 수 있다.

```{r}
#| eval: false
all.equal(locMvC_p, (locC_p+locC_p_II)/2,
          check.attributes = FALSE)
# [1] TRUE
```

```{r}
#| eval: false
locMvC_p |> hotspot(Prname = "Pr(z != E(Ci)) Sim",
                    cutoff = 0.005) -> pol_pres15$hs_MvC
```

![FDR 조정 핫스팟 지도(양측검정, 흥미로움의 판정 기준값 0.005 적용). 왼쪽 패널에는 1차 투표율에 대한 공간 클러스터, 가운데 패널에는 2차 투표율에 대한 공간 클러스터, 오른쪽 패널에는 두 차례 투표율 모두에 대한 공간 클러스터가 나타나 있다.(행표준화 공간가중치행렬의 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localCmulti-1.png){#fig-15-8}

그림 15.8은 다변량 측도가 개별 단변량 측도에서 흥미로운 케이스로 식별된 관측 개체들을 기본적으로 결합하고 있음을 보여준다. 이를 구체적으로 살펴보기 위해, 1차 및 2차 투표의 단변량 측도값을 결합한 뒤 이를 다변량 측도값과 대조하여 표로 정리할 수 있다.

```{r}
#| eval: false
table(droplevels(interaction(addNA(pol_pres15$hs_C),
                             addNA(pol_pres15$hs_C_II), sep=":")), 
      addNA(pol_pres15$hs_MvC))
#                      
#                       Positive <NA>
#   High-High:High-High       81    0
#   NA:High-High              41   27
#   Low-Low:Low-Low           25    0
#   NA:Low-Low                43   11
#   NA:Other Positive          1    0
#   NA:Negative                0    1
#   High-High:NA              15    0
#   Low-Low:NA                11    3
#   NA:NA                     36 2200
```

다변량 $C_i$에서는 흥미로운 케이스로 식별된 관측 개체 중 47개는 단변량 $C_i$ 어느 경우에서도 흥미로운 케이스로 나타나지 않았다(FDR, 판정 기준값 0.005). 1차와 2차 라운드 모두에서 흥미로운 것으로 나타난 관측값은 거의 모두 다변량에서도 흥미로운 것으로 분류되었지만, 두 라운드 중 한 라운드에서만 흥미로운 것으로 나타난 관측값은 보다 혼합된 결과를 보였다.

### rgeoda 패키지

**rgeoda** 패키지(Li and Anselin 2022)는 GeoDa의 R 래퍼 패키지로, **spdep** 패키지와 유사한 기능을 제공하여 에어리어 데이터 공간적 자기상관을 탐색할 수 있게 한다. 활성 객체는 컴파일된 작업 공간의 메모리 주소를 참조하는 포인터로 관리되며, 모든 연산이 GeoDa와 동일하게 컴파일된 코드로 실행되므로 **rgeoda** 패키지는 매우 빠른 성능을 제공한다. 다만, 수정이나 기능 확장이 필요할 경우 유연성은 상대적으로 떨어진다.

```{r}
#| eval: false
library(rgeoda)
Geoda_w <- queen_weights(pol_pres15)
summary(Geoda_w)
#                      name               value
# 1 number of observations:                2495
# 2          is symmetric:                 TRUE
# 3               sparsity: 0.00228786229774178
# 4        # min neighbors:                   1
# 5        # max neighbors:                  13
# 6       # mean neighbors:    5.70821643286573
# 7     # median neighbors:                   6
# 8           has isolates:               FALSE
```

비교를 위해, 2015년 폴란드 대통령 선거 투표율에 대한 다변량 $C_i$ 지표를 살펴보자.

```{r}
#| eval: false
lisa <- local_multigeary(Geoda_w, 
    pol_pres15[c("I_turnout", "II_turnout")], 
    cpu_threads = max(detectCores() - 1, 1),
    permutations = 99999, seed = 1)
```

연접 이웃을 비교하면, 이는 위에서 `poly2nb()` 함수를 통해 정의된 것과 동일하다.

```{r}
#| eval: false
all.equal(card(nb_q), lisa_num_nbrs(lisa), 
          check.attributes = FALSE)
# [1] TRUE
```

다변량 $C_i$ 값도 위와 동일하다.

```{r}
#| eval: false
all.equal(lisa_values(lisa), c(locMvC_p),
          check.attributes = FALSE)
# [1] TRUE
```

한 가지 차이점은 **rgeoda** 패키지에서 사용하는 접힌(folded) 양측 순위 기반 순열 유의확률 값의 범위가 $[0,0.5]$로 제한된다는 점이다. 이는 **spdep** 패키지에서도 계산되지만, 처리 방식은 다를 수 있다.

```{r}
#| eval: false
apply(attr(locMvC_p, "pseudo-p")[,c("Pr(z != E(Ci)) Sim", 
                                "Pr(folded) Sim")], 2, range)
#      Pr(z != E(Ci)) Sim Pr(folded) Sim
# [1,]             0.0002         0.0001
# [2,]             0.9990         0.4995
```

이것은 $[0,1]$ 범위에서의 컷오프 값 $0.005$가, $[0,0.5]$ 범위에서는 $0.0025$에 해당함을 의미한다.

```{r}
#| eval: false
locMvC_p |> hotspot(Prname = "Pr(folded) Sim",
                    cutoff = 0.0025) -> pol_pres15$hs_MvCa
```

따라서 `local_multigeary()` 함수는 클러스터 핵심 클래스를 설정할 때 기본 판정 기준값인 $0.05$를 사용하지만, 우리는 이를 더 엄격하게 조정하고, `lisa` 객체의 출력 구성 요소에 FDR 조정을 적용함으로써 결과의 신뢰성을 높일 수 있다.

```{r}
#| eval: false
mvc <- factor(lisa_clusters(lisa), levels=0:2,
              labels = lisa_labels(lisa)[1:3])
is.na(mvc) <- p.adjust(lisa_pvalues(lisa), "fdr") >= 0.0025
pol_pres15$geoda_mvc <- droplevels(mvc)
```

**regoda** 패키지의 순열 방식을 적용한 결과 약 80개의 추가 관측값이 흥미로운 케이스로 확인되었으며, 구현 세부 사항에 대한 추가 분석이 여전히 진행 중이다.

```{r}
#| eval: false
addmargins(table(spdep = addNA(pol_pres15$hs_MvCa),
                 rgeoda = addNA(pol_pres15$geoda_mvc)))
#           rgeoda
# spdep      Positive <NA>  Sum
#   Positive      249    4  253
#   <NA>           75 2167 2242
#   Sum           324 2171 2495
```

![FDR 조정 다변량 $C_i$ 핫스팟 지도(양측검정, 흥미로움의 판정 기준값은 $[0,0.5]$ 범위에서 0.0025 적용). 왼쪽 패널은 합산 투표율을 **spdep** 패키지에 적용한 결과이고, 오른쪽 패널은 합산 투표율을 **rgeoda** 패키지에 적용한 결과이다.(행표준화 공간가중치행렬의 적용)](https://r-spatial.org/book/15-Measures_files/figure-html/fig-localCmultix-1.png){#fig-15-9}

## 연습문제

1.  체스판의 조인 카운트 통계값이 `rook` 이웃과 `queen` 이웃 간에 크게 다른 이유를 설명하시오.

2.  15.1절에서 제시한 시뮬레이션을 체스판 다각형과 행 표준화된 `queen` 연접 이웃을 사용하여 반복하시오. 공간적 자기상관이 일반적으로 (피할 수 없는) 데이터의 모형 오지정 문제를 나타낼 수 있다는 점을 이해하는 것이 왜 중요한지 설명하시오.

3.  국지적 공간적 자기상관 통계량에 FDR 조정이 권장되는 이유를 설명하시오.

4.  문항 2의 시뮬레이션 데이터에 대해 분석적 조건 접근법과 안장점 근사법을 사용하여 $I_i$의 표준편차 값(검정 통계값)을 비교하시오. 또한 안장점 근사법의 장단점을 설명하시오.
