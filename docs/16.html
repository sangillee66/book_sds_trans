<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xml:lang="ko"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>공간데이터사이언스 개론 - 16&nbsp; 공간적 회귀분석</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./17.html" rel="next">
<link href="./15.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "일치 없음",
    "search-matching-documents-text": "일치된 문서",
    "search-copy-link-title": "검색 링크 복사",
    "search-hide-matches-text": "추가 검색 결과 숨기기",
    "search-more-match-text": "추가 검색결과",
    "search-more-matches-text": "추가 검색결과",
    "search-clear-button-title": "제거",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "취소",
    "search-submit-button-title": "검색",
    "search-label": "검색"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="styles.css">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="사이드바 전환" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="사이드바 전환" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title"><span id="sec-regression" class="quarto-section-identifier"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">공간적 회귀분석</span></span></h1>
        </a>     
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">공간데이터사이언스 개론</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/sangillee66/book_sds_trans" title="소스 코드" class="quarto-navigation-tool px-1" aria-label="소스 코드"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="검색"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">서장</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">공간데이터</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="토글 섹션">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">시작하기</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">좌표계</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">지오메트리</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">구체 지오메트리</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">속성과 서포트</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">데이터 큐브</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">공간데이터사이언스와 R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="토글 섹션">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">sf와 stars</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">공간데이터의 플로팅</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">대용량 데이터와 클라우드 네이티브</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">공간통계분석과 공간모델링</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="토글 섹션">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">공간데이터의 통계적 모델링</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">포인트 패턴 분석</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">공간적 인터폴레이션</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">다변량 및 시공간 지구통계학</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">근접성과 에어리어 데이터</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">공간적 자기상관 측도</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">공간적 회귀분석</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">공간계량경제학적 모델</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">부록</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="토글 섹션">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">R 스페셜 패키지</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R 기초</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">목차</h2>
   
  <ul>
<li>
<a href="#%EB%A7%88%EB%A5%B4%EC%BD%94%ED%94%84-%EB%9E%9C%EB%8D%A4-%ED%95%84%EB%93%9C%EC%99%80-%EB%8B%A4%EC%88%98%EC%A4%80-%EB%AA%A8%EB%8D%B8" id="toc-마르코프-랜덤-필드와-다수준-모델" class="nav-link active" data-scroll-target="#%EB%A7%88%EB%A5%B4%EC%BD%94%ED%94%84-%EB%9E%9C%EB%8D%A4-%ED%95%84%EB%93%9C%EC%99%80-%EB%8B%A4%EC%88%98%EC%A4%80-%EB%AA%A8%EB%8D%B8"><span class="header-section-number">16.1</span> 마르코프 랜덤 필드와 다수준 모델</a>
  <ul class="collapse">
<li><a href="#%EB%B3%B4%EC%8A%A4%ED%84%B4-%EC%A3%BC%ED%83%9D%EA%B0%80%EA%B2%A9-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%85%8B" id="toc-보스턴-주택가격-데이터셋" class="nav-link" data-scroll-target="#%EB%B3%B4%EC%8A%A4%ED%84%B4-%EC%A3%BC%ED%83%9D%EA%B0%80%EA%B2%A9-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%85%8B"><span class="header-section-number">16.1.1</span> 보스턴 주택가격 데이터셋</a></li>
  </ul>
</li>
  <li>
<a href="#%EB%B3%B4%EC%8A%A4%ED%84%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%85%8B%EC%97%90-%EB%8C%80%ED%95%9C-%EB%8B%A4%EC%88%98%EC%A4%80-%EB%AA%A8%EB%8D%B8" id="toc-보스턴-데이터셋에-대한-다수준-모델" class="nav-link" data-scroll-target="#%EB%B3%B4%EC%8A%A4%ED%84%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%85%8B%EC%97%90-%EB%8C%80%ED%95%9C-%EB%8B%A4%EC%88%98%EC%A4%80-%EB%AA%A8%EB%8D%B8"><span class="header-section-number">16.2</span> 보스턴 데이터셋에 대한 다수준 모델</a>
  <ul class="collapse">
<li><a href="#iid-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-lme4-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-%ED%99%9C%EC%9A%A9" id="toc-iid-랜덤-효과-lme4-패키지의-활용" class="nav-link" data-scroll-target="#iid-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-lme4-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-%ED%99%9C%EC%9A%A9"><span class="header-section-number">16.2.1</span> IID 랜덤 효과: lme4 패키지의 활용</a></li>
  <li><a href="#iid%EC%99%80-car-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-hglm-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-%ED%99%9C%EC%9A%A9" id="toc-iid와-car-랜덤-효과-hglm-패키지의-활용" class="nav-link" data-scroll-target="#iid%EC%99%80-car-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-hglm-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-%ED%99%9C%EC%9A%A9"><span class="header-section-number">16.2.2</span> IID와 CAR 랜덤 효과: hglm 패키지의 활용</a></li>
  <li><a href="#iid%EC%99%80-icar-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-r2bayesx-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-%ED%99%9C%EC%9A%A9" id="toc-iid와-icar-랜덤-효과-r2bayesx-패키지의-활용" class="nav-link" data-scroll-target="#iid%EC%99%80-icar-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-r2bayesx-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-%ED%99%9C%EC%9A%A9"><span class="header-section-number">16.2.3</span> IID와 ICAR 랜덤 효과: R2BayesX 패키지의 활용</a></li>
  <li><a href="#iid-icar-lerouzx-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-inla-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-%ED%99%9C%EC%9A%A9" id="toc-iid-icar-lerouzx-랜덤-효과-inla-패키지의-활용" class="nav-link" data-scroll-target="#iid-icar-lerouzx-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-inla-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-%ED%99%9C%EC%9A%A9"><span class="header-section-number">16.2.4</span> IID, ICAR, Lerouzx 랜덤 효과: INLA 패키지의 활용</a></li>
  <li><a href="#icar-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-mgcv-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-gam-%ED%95%A8%EC%88%98%EC%9D%98-%ED%99%9C%EC%9A%A9" id="toc-icar-랜덤-효과-mgcv-패키지의-gam-함수의-활용" class="nav-link" data-scroll-target="#icar-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-mgcv-%ED%8C%A8%ED%82%A4%EC%A7%80%EC%9D%98-gam-%ED%95%A8%EC%88%98%EC%9D%98-%ED%99%9C%EC%9A%A9"><span class="header-section-number">16.2.5</span> ICAR 랜덤 효과: mgcv 패키지의 <code>gam()</code> 함수의 활용</a></li>
  <li><a href="#%EC%83%81%EC%9C%84-%EC%88%98%EC%A4%80-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-%EC%9A%94%EC%95%BD" id="toc-상위-수준-랜덤-효과-요약" class="nav-link" data-scroll-target="#%EC%83%81%EC%9C%84-%EC%88%98%EC%A4%80-%EB%9E%9C%EB%8D%A4-%ED%9A%A8%EA%B3%BC-%EC%9A%94%EC%95%BD"><span class="header-section-number">16.2.6</span> 상위-수준 랜덤 효과: 요약</a></li>
  </ul>
</li>
  <li><a href="#%EC%97%B0%EC%8A%B5%EB%AC%B8%EC%A0%9C" id="toc-연습문제" class="nav-link" data-scroll-target="#%EC%97%B0%EC%8A%B5%EB%AC%B8%EC%A0%9C"><span class="header-section-number">16.3</span> 연습문제</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/sangillee66/book_sds_trans/issues/new" class="toc-action"><i class="bi bi-github"></i>이슈 보고</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title d-none d-lg-block"><span id="sec-regression" class="quarto-section-identifier"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">공간적 회귀분석</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">2025년 1월 4일</p>
    </div>
  </div>
    
  </div>
  


</header><p>에어리어 서포트를 가지는 한 변수가 주어졌을 때 그것이 보여주는 공간적 패턴의 해석에 집중하는 것은 의미있는 일이다. 그러나 해당 변수의 공간적 패턴을 설명하고자 한다면, 즉 해당 변수를 반응 변수로 간주한다면 얘기는 좀 달라진다. 왜냐하면 반응 변수과 보여주는 공간적 패턴을 주로 공변량(및 그 함수 형태)에 기인한 것일 가능성이 크고, 개별 변수의 영향력이 작동하는 공간적 범위에 영향을 받기 때문이다. 이차원 공간적 자기회귀 모델은 공변량 없이 시작되었으며, 시계열 분석 모델과 명확한 연관성을 가지고 있다(Whittle, 1954). 이후 선형 모델 잔차에서 공간적 자기상관을 검정하는 방법과 자기회귀 성분을 반응 변수나 잔차에 적용하는 모델로 확장되었는데, 자기회귀 성분을 잔차에 적용하는 모델은 잔차에 대한 검정과 일치하는 것이었다(Cliff and Ord, 1972, 1973). 이러한 에어리어 데이터에 대한 “격자(lattice)” 모델은 일반적으로 연접성 행렬 형태의 이웃 관계 그래프를 사용하여 관측값 간의 공간적 의존성을 나타낸다.</p>
<p>물론, 일반화 최소제곱 모델이나 <strong>nlme</strong> 및 기타 여러 패키지에서 제공하는 (일반화) 선형 또는 비선형 혼합효과 모델에서 공간적 자기상관을 다루는 데 반드시 이웃 관계 그래프를 사용할 필요는 없다(Pinheiro and Bates, 2000). 관측값 간의 거리 함수를 사용하거나 공간적 자기상관을 모델링하기 위해 베리오그램을 적합하는 것 역시 공간적 회귀 모델의 일종이라고 말할 수 있다. 이러한 접근은 기저 과정에 대한 더 명확한 이해를 제공한다고 평가되었으며(Wall, 2004), 지구통계학에 기반을 두고 있다. 예를 들어, <strong>glmmTMB</strong> 패키지는 이 접근법을 활용해 공간적 회귀분석을 성공적으로 수행한다(Brooks et al., 2017). 하지만 본 장에서는 공간 가중치 행렬을 사용하는 공간적 회귀분석만을 고려할 것이다.</p>
<section id="마르코프-랜덤-필드와-다수준-모델" class="level2" data-number="16.1"><h2 data-number="16.1" class="anchored" data-anchor-id="마르코프-랜덤-필드와-다수준-모델">
<span class="header-section-number">16.1</span> 마르코프 랜덤 필드와 다수준 모델</h2>
<p>질병 지도화(disease mapping) 연구에서는 공간적으로 구조화된 임의 효과를 다루기 위해 조건부(conditional) 자기회귀(CAR) 모델과 내재적(intrinsic) 자기회귀(ICAR) 모델을 사용하는 광범위한 연구가 존재한다. 이러한 모델은 다수준 모델로 확장될 수 있으며, 공간적으로 구조화된 임의 효과가 모델의 서로 다른 수준에서 적용될 수 있다(Bivand et al., 2017). 여러 변형을 시도하기 위해, 우리는 트랙트(tract) 수준과 모델 출력 구역 집계(model output zone aggregated) 수준을 두 단계로 나누어 이웃이 없는 관측값을 제거해야 한다. 트랙트 수준에서 이웃 관계가 줄어들면 모델 출력 구역 수준에서도 이웃이 없는 결과가 발생할 수 있기 때문이다. 모델 추정 함수의 대부분은 <code>family</code> 아규먼트를 사용하며, 이웃 간 관계를 마르코프 랜덤 필드로 표현한 공간 랜덤 효과를 통해 각 관측값에 대해 일반화 선형 혼합효과 모델을 적합한다. 다수준 모델의 경우, 랜덤 효과는 그룹 수준에서 모델화될 수 있으며, 아래의 예시에 적용되어 있다.</p>
<p>공간적 회귀분석을 혼합 효과 모델에 의거해 설명하는 Pinheiro and Bates (2000)와 McCulloch and Searle (2001)의 논리가 중요한데, Gómez-Rubio (2019)의 표현식을 딸라 설명하고자 한다. 반응 변수 <span class="math inline">\(Y\)</span>, 고정 공변량 <span class="math inline">\(X\)</span>, 회귀계수 <span class="math inline">\(\beta\)</span>, 오차 항 <span class="math inline">\(\epsilon_i\sim N(0, \sigma^2), i=1,...,n\)</span>이 주어진 상태에서 랜덤 효과 <span class="math inline">\(u\)</span>가 첨가되면, 가우시안 선형 혼합 효과 모델은 다음과 같이 정의된다.</p>
<p><span class="math display">\[
Y=X\beta+Zu+\epsilon
\]</span></p>
<p>여기서 <span class="math inline">\(Z\)</span>는 랜덤 효과를 위한 고정 디자인 행렬이다. 만약 <span class="math inline">\(n\)</span>개의 랜덤 효과가 있다면, <span class="math inline">\(n \times n\)</span> 단위 행렬이 되고, 만일 관측값이 <span class="math inline">\(m\)</span>개의 그룹으로 집계되어 <span class="math inline">\(m&lt;n\)</span>의 랜덤 효과만 있다면 각 관측값이 어느 그룹에 속하는지를 나타내는 <span class="math inline">\(n \times m\)</span>행렬이 된다. 랜덤 효과는 다변량 정규 분포 <span class="math inline">\(u\sim N(0,\sigma_u^2 \sum)\)</span>로 모델화되며, <span class="math inline">\(\sigma_u^2 \sum\)</span>은 랜덤 효과의 분산-공분산 행렬이다.</p>
<p>CAR 모델(Besag, 1974)과 SAR(simultaneous autoregressive) 모델(Ord, 1975; Hepple, 1976)이 분리되어 발전해 왔는데, 이러한 구분의 유익함은 사실 별로 없다. CAR 모델과 SAR 모델은 밀접하게 연관되어 있음에도 불구하고 , 이 두 분야는 유사한 모델을 적용하는 경험을 공유하는데 어려움을 겪고 있다. 이러한 어려움은 CAR과 SAR 모델을 정리한 핵심 저작(Ripley, 1981, 1988; Cressie, 1993)을 참고하는 경우에도 마찬가지이다. Ripley는 SAR의 분산을 제시한 바 있는데(Ripley, 1981, 89), 여기서는 <span class="math inline">\(\sum^{-1}\)</span>(정밀도 행렬로도 알려짐)로 나타낸다.</p>
<p><span class="math display">\[
\Sigma^{-1}=[(I-\rho W)'(I-\rho W)]
\]</span></p>
<p>여기서 <span class="math inline">\(\rho\)</span>는 공간적 자기상관 파라미터이고, <span class="math inline">\(W\)</span>는 공간적 의존성을 나타내는 비단일(non-singular) 공간 가중치 행렬이다. CAR 분산을 다음과 같이 주어진다.</p>
<p><span class="math display">\[
\Sigma^{-1}=(I=\rho W)
\]</span></p>
<p>여기서 <span class="math inline">\(W\)</span>는 대칭적이고 엄격히 양의 정의인 공간 가중치 행렬이다. 내재적 CAR 모델의 경우, 공간적 자가상관 파라미터를 추정하지 않으며 다음과 같은 형태로 주어진다.</p>
<p><span class="math display">\[
\Sigma^{-1}=M=\text{diag}(n_i)-W
\]</span></p>
<p>여기서 <span class="math inline">\(W\)</span>는 앞서 언급한 것처럼 대칭적이고 엄격히 양의 정의인 공간 가중치 행렬이며,<br><span class="math inline">\(n_i\)</span>은 <span class="math inline">\(W\)</span>의 행 합산값을 나타낸다. Besag-York-Mollié 모델은 내재적 CAR 공간 구조화된 랜덤 효과와 비구조화된 랜덤 효과를 포함한다. Leroux 모델은 비구조화된 랜덤 효과와 공간 구조화된 랜덤 효과의 행렬 구성 요소를 결합하며, 공간 구조화된 랜덤 효과는 내재적 CAR의 정의를 따르는 것으로 간주된다.</p>
<p><span class="math display">\[
\Sigma^{-1}=[(1-\rho)I_n+
\rho M]
\]</span></p>
<p>이 모델들의 정의에 대해서는 Gómez-Rubio (2020)를 참조할 수 있고, Besag-York-Mollié와 Leroux 모델에 영향을 미치는 추정 문제에 대해서는 Gerber and Furrer (2015)에서 다루어진다.</p>
<p>에어리어 데이터 모델링의 이론적 기초를 다루고 있는 최근의 서적(Gaetan and Guyon, 2010; Van Lieshout, 2019)은 SAR 모델과 CAR 모델의 유사성을 몇몇 장에서 지적하고 있다. 배경 정보에 관심이 있는 독자는 이 서적들을 참고하면 된다.</p>
<section id="보스턴-주택가격-데이터셋" class="level3" data-number="16.1.1"><h3 data-number="16.1.1" class="anchored" data-anchor-id="보스턴-주택가격-데이터셋">
<span class="header-section-number">16.1.1</span> 보스턴 주택가격 데이터셋</h3>
<p>여기서는 보스턴 주택 데이터셋을 사용할 것이다. 이 데이터셋은 센서스 트랙트 경계에 맞추어 재구성되었다(Bivand 2017). 원 데이터셋은 506개의 센서스 트랙트로 구성되었으며, 깨끗한 공기에 대한 지불 의사를 추정하기 위해 헤도닉 모델을 사용했다. 반응 변수는 1970년 센서스의 주택 가치에 대한 서열 응답(클래스)에 대한 카운트로부터 생성되었다. 이 반응 변수는 센서스 원본에서 좌측 및 우측 검열되었으며, 가우시안 분포로 처리되었다. 주요 공변량은 연간 질소산화물(NOX) 수준을 보여주는 기상 모델에 기반하여 생성되었으며 소수의 모델 산출 구역 단위로 주어진다. 주택 응답 수는 트랙트와 모델 출력 존별로도 다르다. 다른 공변량도 여러 개 포함되어 있으며, 일부는 트랙트 수준에서 측정되었고, 일부는 타운 단위로만 측정되었는데, 이 타운들은 대체로 대기오염 모델 출력 존과 일치한다.</p>
<p>우리는 먼저 <strong>spData</strong> 패캐지(Bivand, Nowosad, and Lovelace 2022)에서 506개 트랙트 데이터셋을 불러온 뒤, 인접성 이웃 객체를 생성하고 이를 기반으로 행 표준화된 공간 가중치 객체를 생성한다.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jakubnowosad.com/spData/">spData</a></span><span class="op">)</span></span>
<span><span class="va">boston_506</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"shapes/boston_tracts.shp"</span>,</span>
<span>                      package <span class="op">=</span> <span class="st">"spData"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_q</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">)</span></span>
<span><span class="va">lw_q</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">nb_q</span>, style <span class="op">=</span> <span class="st">"W"</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>중위 주택 가격 데이터를 살펴보면, 검열된 값들은 결측값으로 지정되었으며, 이로 인해 17개의 트랙트가 영향을 받았음을 알 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">$</span><span class="va">censored</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#  left    no right </span></span>
<span><span class="co">#     2   489    15</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">$</span><span class="va">median</span><span class="op">)</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's </span></span>
<span><span class="co">#    5600   16800   21000   21749   24700   50000      17</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>다음으로, 비검열 주택 가격값을 가진 나머지 489개 트랙트로 서브셋을 만들고, 여기에 맞추어 이웃 객체도 조정한다. 이렇게 하면 이웃이 없는 관측값이 하나 존재하게 된다.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_506</span><span class="op">$</span><span class="va">CHAS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">$</span><span class="va">CHAS</span><span class="op">)</span></span>
<span><span class="va">boston_489</span> <span class="op">&lt;-</span> <span class="va">boston_506</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">$</span><span class="va">median</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">nb_q_489</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">boston_489</span><span class="op">)</span></span>
<span><span class="va">lw_q_489</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">nb_q_489</span>, style <span class="op">=</span> <span class="st">"W"</span>,</span>
<span>                            zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>상위 집계 수준을 정의하는 <code>NOX_ID</code> 변수를 활용하여 트랙트 수준의 데이터를 대기오염 모델 출력 구역으로 집계한다. 이웃 객체와 행 표준화된 공간 가중치 객체를 생성하고, <code>NOX</code> 변수는 평균값을 사용해 재계산하고, 찰스강 상의 관측단위인지 아닌지에 대한 더미 변수 <code>CHAS</code>도 재계산한다. 여기서는 5.3.1절에서 설명한 원칙, 즉 공간적으로 외연적인 변수와 내포적인 변수를 다르게 취급하는 원칙을 따른다. <code>NOX</code>와 <code>CHAS</code>는 모두 카운트 변수가 아니기 때문에 합계를 통해 재계산할 수 없다.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">agg_96</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">boston_96</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">[</span>, <span class="st">"NOX_ID"</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">agg_96</span>,</span>
<span>                       <span class="va">unique</span><span class="op">)</span></span>
<span><span class="va">nb_q_96</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">boston_96</span><span class="op">)</span></span>
<span><span class="va">lw_q_96</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">nb_q_96</span><span class="op">)</span></span>
<span><span class="va">boston_96</span><span class="op">$</span><span class="va">NOX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">$</span><span class="va">NOX</span>, <span class="va">agg_96</span>, <span class="va">mean</span><span class="op">)</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="va">boston_96</span><span class="op">$</span><span class="va">CHAS</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">$</span><span class="va">CHAS</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, <span class="va">agg_96</span>, <span class="va">max</span><span class="op">)</span><span class="op">$</span><span class="va">x</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>반응 변수의 집계는 <strong>matrixStats</strong> 패키지의 <code>weightedMedian</code> 함수를 통해 이루어지는데, 주택 가격 클래스의 중간값을 기준으로 계산된다. 주택 가격 클래스별 주택 수를 산출하는 것이 매우 중요한데, 센서스 공표 데이터를 검증하는데 사용될 수도 있다. 트랙트 수준에서 <code>weightedMedian</code>을 적용하면 공표 값이 계산되어 나오는 것을 확인할 수 있다. 반응 변수에 대한 집계 결과, 두 개의 출력 구역의 가중 중위값이 주택 가격에 대한 최상위 클래스의 한계 값인 5만 달러는 초과하는 것으로 확인되어 최종적으로 제거되었다. 이렇게 큰 가중 중위값은 최상의 클래스의 중간값을 어떻게 설정하는냐와 관련된 문제이기도 하다. 주택 가격 클래스별 주택 수를 계산하는 것은 공간적으로 외연적인 집계에 해당하므로 재계산을 위한 함수로 합계를 적용하는 것이 적절하다.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">)</span></span>
<span><span class="va">ccounts</span> <span class="op">&lt;-</span> <span class="fl">23</span><span class="op">:</span><span class="fl">31</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nm</span> <span class="kw">in</span> <span class="va">nms</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">22</span>, <span class="va">ccounts</span>, <span class="fl">36</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">boston_96</span><span class="op">[[</span><span class="va">nm</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">[[</span><span class="va">nm</span><span class="op">]</span><span class="op">]</span>, <span class="va">agg_96</span>, <span class="va">sum</span><span class="op">)</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="op">}</span></span>
<span><span class="va">br2</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.50</span>, <span class="fl">6.25</span>, <span class="fl">8.75</span>, <span class="fl">12.5</span>, <span class="fl">17.5</span>, <span class="fl">22.5</span>, <span class="fl">30</span>, <span class="fl">42.5</span>, <span class="fl">60</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">boston_96</span><span class="op">)</span><span class="op">[</span>, <span class="va">nms</span><span class="op">[</span><span class="va">ccounts</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">matrixStats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/weightedMedian.html">weightedMedian</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">br2</span>, w <span class="op">=</span> <span class="va">x</span>,</span>
<span>                                     interpolate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">boston_96</span><span class="op">$</span><span class="va">median</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fl">1</span>, <span class="va">f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">boston_96</span><span class="op">$</span><span class="va">median</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">boston_96</span><span class="op">$</span><span class="va">median</span> <span class="op">&gt;</span> <span class="fl">50000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">boston_96</span><span class="op">$</span><span class="va">median</span><span class="op">)</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's </span></span>
<span><span class="co">#    9009   20417   23523   25263   30073   49496       2</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>나머지 공변량은 트랙트 수준의 센스서 인구 수를 활용하여 가중 평균을 산출함으로서(Bivand 2017) 집계 절차를 진행한다. 공변량들이 카운트 데이터가 아니라 공간적으로 내포적인 변수이기 때문에 이렇게 한다. 이 집계 과정을 이어서 서브세팅을 한다.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">POP</span> <span class="op">&lt;-</span> <span class="va">boston_506</span><span class="op">$</span><span class="va">POP</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">matrixStats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/weightedMean.html">weightedMean</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nm</span> <span class="kw">in</span> <span class="va">nms</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">11</span>, <span class="fl">14</span><span class="op">:</span><span class="fl">19</span>, <span class="fl">21</span>, <span class="fl">33</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">boston_506</span><span class="op">[[</span><span class="va">nm</span><span class="op">]</span><span class="op">]</span>, <span class="va">POP</span><span class="op">)</span>, <span class="va">agg_96</span><span class="op">)</span></span>
<span>  <span class="va">boston_96</span><span class="op">[[</span><span class="va">nm</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">s0</span>, <span class="va">f</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">boston_94</span> <span class="op">&lt;-</span> <span class="va">boston_96</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">boston_96</span><span class="op">$</span><span class="va">median</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">nb_q_94</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/subset.nb.html">subset.nb</a></span><span class="op">(</span><span class="va">nb_q_96</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">boston_96</span><span class="op">$</span><span class="va">median</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lw_q_94</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">nb_q_94</span>, style<span class="op">=</span><span class="st">"W"</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>이제 두 개의 데이터셋이 두 개의 서로 다른 수준에서 존재한다. 즉, 하위 수준인 센서스 트랙트 수준과 상위 수준인 대기오염 모델 출력 구역 수준이다. 하나는 검열된 관측값을 포함하고 있고, 다른 하나는 이를 제외한 데이터이다.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_94a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">boston_489</span><span class="op">[</span>,<span class="st">"NOX_ID"</span><span class="op">]</span>, </span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">boston_489</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span>, <span class="va">unique</span><span class="op">)</span></span>
<span><span class="va">nb_q_94a</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">boston_94a</span><span class="op">)</span></span>
<span><span class="va">NOX_ID_no_neighs</span> <span class="op">&lt;-</span></span>
<span>        <span class="va">boston_94a</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/card.html">card</a></span><span class="op">(</span><span class="va">nb_q_94a</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">boston_487</span> <span class="op">&lt;-</span> <span class="va">boston_489</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">boston_489</span><span class="op">$</span><span class="va">NOX_ID</span>,</span>
<span>                                     <span class="va">NOX_ID_no_neighs</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">boston_93</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">boston_487</span><span class="op">[</span>, <span class="st">"NOX_ID"</span><span class="op">]</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ids <span class="op">=</span> <span class="va">boston_487</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span>, <span class="va">unique</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="va">boston_93</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">boston_93</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span></span>
<span><span class="va">nb_q_93</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">boston_93</span>,</span>
<span>        row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">boston_93</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>원래 모델은 트랙트별 중위 주택 가격의 로그값과 NOX 값의 제곱의 관련성에 관한 것이었는데, 주로 트랙트별 주택 가격과 관련된 다른 공변량(예: 총 방 수, 총 연령, 민족, 사회적 지위, 중심가까지 거리, 가장 가까운 방사형 도로까지 거리, 범죄율, 도시 수준 변수 등)을 포함하였다(Bivand 2017). 이 데이터를 활용하여 공간 회귀 모델을 적합할 때 발생할 수 있는 문제들에 대해 살펴볼 것이다. 이 데이터는 다수준 이슈를 다루는데도 유용하다.</p>
</section></section><section id="보스턴-데이터셋에-대한-다수준-모델" class="level2" data-number="16.2"><h2 data-number="16.2" class="anchored" data-anchor-id="보스턴-데이터셋에-대한-다수준-모델">
<span class="header-section-number">16.2</span> 보스턴 데이터셋에 대한 다수준 모델</h2>
<p>ZN, INDUS, NOX, RAD, TAX, 및 PTRATIO 변수는 TASSIM 구역 내에서 변동이 거의 없음을 보여주며, 따라서 다수준 모델에서는 랜덤 효과가 이들의 영향을 흡수할 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">median</span><span class="op">)</span> <span class="op">~</span> <span class="va">CRIM</span> <span class="op">+</span> <span class="va">ZN</span> <span class="op">+</span> <span class="va">INDUS</span> <span class="op">+</span> <span class="va">CHAS</span> <span class="op">+</span> </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">NOX</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">RM</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">AGE</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">DIS</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">RAD</span><span class="op">)</span> <span class="op">+</span> <span class="va">TAX</span> <span class="op">+</span> <span class="va">PTRATIO</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">BB</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">LSTAT</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="iid-랜덤-효과-lme4-패키지의-활용" class="level3" data-number="16.2.1"><h3 data-number="16.2.1" class="anchored" data-anchor-id="iid-랜덤-효과-lme4-패키지의-활용">
<span class="header-section-number">16.2.1</span> IID 랜덤 효과: lme4 패키지의 활용</h3>
<p><strong>lme4</strong> 패키지(Bates et al.&nbsp;2022)는 모델 출력 구역 수준에서 독립동일분포(IID)를 보이는 비구조적 랜덤 효과를 추가할 수 있게 해준다. 이는 모델 포뮬러에 랜덤 효과 항을 업데이트하는 방식으로 이루어진다.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="va">MLM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">NOX_ID</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            data <span class="op">=</span> <span class="va">boston_487</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>랜덤 효과를 <code>"sf"</code> 객체에 복사하여 나중에 지도로 표현할 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_93</span><span class="op">$</span><span class="va">MLM_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">MLM</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="iid와-car-랜덤-효과-hglm-패키지의-활용" class="level3" data-number="16.2.2"><h3 data-number="16.2.2" class="anchored" data-anchor-id="iid와-car-랜덤-효과-hglm-패키지의-활용">
<span class="header-section-number">16.2.2</span> IID와 CAR 랜덤 효과: hglm 패키지의 활용</h3>
<p>동일한 모델을 <strong>hglm</strong> 패키지를 사용하여 추정할 수 있는데(Alam, Ronnegard, and Shen 2019), 랜덤 효과 항을 나타내는 한쪽 방향 포뮬러(one-sided formula)를 추가하는 방식으로 이루어진다.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">hglm</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="va">HGLM_iid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hglm/man/hglm.html">hglm</a></span><span class="op">(</span>fixed <span class="op">=</span> <span class="va">form</span>,</span>
<span>                                  random <span class="op">=</span> <span class="op">~</span><span class="fl">1</span> <span class="op">|</span> <span class="va">NOX_ID</span>,</span>
<span>                                  data <span class="op">=</span> <span class="va">boston_487</span>,</span>
<span>                                  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">boston_93</span><span class="op">$</span><span class="va">HGLM_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">HGLM_iid</span><span class="op">$</span><span class="va">ranef</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>hglm</strong> 패키지는 공간적으로 구조화된 SAR과 CAR 랜덤 효과도 다룰 수 있게 확장되었으며, 이 경우 희소 공간 가중치 행렬이 필요하다(Alam, Rönnegård, and Shen 2015). 여기서는 이진 공간 가중치를 사용한다.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spatialreg/">spatialreg</a></span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">nb_q_93</span>, style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>and.family</code> 아규먼트를 사용하여 상위 수준에서 CAR 모델을 적합한다. 이 때 인덱싱 변수인 <code>NOX_ID</code>의 값이 <span class="math inline">\(W\)</span>의 행 이름과 일치하도록 한다.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="va">HGLM_car</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/hglm/man/hglm.html">hglm</a></span><span class="op">(</span>fixed <span class="op">=</span> <span class="va">form</span>,</span>
<span>                                  random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">NOX_ID</span>,</span>
<span>                                  data <span class="op">=</span> <span class="va">boston_487</span>,</span>
<span>                                  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                  rand.family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/hglm/man/CAR.html">CAR</a></span><span class="op">(</span>D<span class="op">=</span><span class="va">W</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">boston_93</span><span class="op">$</span><span class="va">HGLM_ss</span> <span class="op">&lt;-</span> <span class="va">HGLM_car</span><span class="op">$</span><span class="va">ranef</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="iid와-icar-랜덤-효과-r2bayesx-패키지의-활용" class="level3" data-number="16.2.3"><h3 data-number="16.2.3" class="anchored" data-anchor-id="iid와-icar-랜덤-효과-r2bayesx-패키지의-활용">
<span class="header-section-number">16.2.3</span> IID와 ICAR 랜덤 효과: R2BayesX 패키지의 활용</h3>
<p><strong>R2BayesX</strong> 패키지(Umlauf et al.&nbsp;2022)는 공간 다수준 모델을 포함한 다양한 구조화된 가법(additive) 회귀 모델을 지원한다. 지원 모델 중 하나가 상위 레벨에서의 IID 비구조적 랜덤 효과 모델인데, <code>sx</code> 모델 항에 <code>"re"</code> 사양을 사용하면 된다(Umlauf et al.&nbsp;2015). “MCMC” 메소드를 선택한다.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">R2BayesX</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">BX_iid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/bayesx.html">bayesx</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/sx.html">sx</a></span><span class="op">(</span><span class="va">NOX_ID</span>, bs <span class="op">=</span> <span class="st">"re"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 family <span class="op">=</span> <span class="st">"gaussian"</span>, data <span class="op">=</span> <span class="va">boston_487</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"MCMC"</span>, iterations <span class="op">=</span> <span class="fl">12000</span>,</span>
<span>                 burnin <span class="op">=</span> <span class="fl">2000</span>, step <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_93</span><span class="op">$</span><span class="va">BX_re</span> <span class="op">&lt;-</span> <span class="va">BX_iid</span><span class="op">$</span><span class="va">effects</span><span class="op">[</span><span class="st">"sx(NOX_ID):re"</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Mean</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>상위 수준의 <code>"nb"</code> 객체를 토대로 <code>"mrf"</code> (Markov Random Field) 공간적으로 구조화된 내재적 CAR 랜덤 효과 사양을 선택한다. <code>"nb"</code> 객체의 <code>"region.id"</code> 속성은 <code>sx</code> 효과 항의 인덱싱 변수와 일치하는 값을 포함할 필요가 있는데, 이는 설계 행렬 <span class="math inline">\(Z\)</span>의 내부 구조화를 용이하게 하려는 것이다.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">RBX_gra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/nbAndGraConversion.html">nb2gra</a></span><span class="op">(</span><span class="va">nb_q_93</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="va">RBX_gra</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">nb_q_93</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>위의 내재적 CAR 모델 정의에서 본 것처럼, 이웃 수는 대각선에 입력되지만, 현재 구현에서는 희소가 아닌 밀집 행렬을 사용한다.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">RBX_gra</span><span class="op">)</span><span class="op">)</span>, <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/card.html">card</a></span><span class="op">(</span><span class="va">nb_q_93</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>sx</code> 모델 항은 여전히 인덱싱 변수를 포함하며, 이제 내재적 CAR 정밀 행렬을 통과한다.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">BX_mrf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/bayesx.html">bayesx</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/sx.html">sx</a></span><span class="op">(</span><span class="va">NOX_ID</span>, bs <span class="op">=</span> <span class="st">"mrf"</span>,</span>
<span>                                         map <span class="op">=</span> <span class="va">RBX_gra</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 family <span class="op">=</span> <span class="st">"gaussian"</span>, data <span class="op">=</span> <span class="va">boston_487</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"MCMC"</span>, iterations <span class="op">=</span> <span class="fl">12000</span>,</span>
<span>                 burnin <span class="op">=</span> <span class="fl">2000</span>, step <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_93</span><span class="op">$</span><span class="va">BX_ss</span> <span class="op">&lt;-</span> <span class="va">BX_mrf</span><span class="op">$</span><span class="va">effects</span><span class="op">[</span><span class="st">"sx(NOX_ID):mrf"</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Mean</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="iid-icar-lerouzx-랜덤-효과-inla-패키지의-활용" class="level3" data-number="16.2.4"><h3 data-number="16.2.4" class="anchored" data-anchor-id="iid-icar-lerouzx-랜덤-효과-inla-패키지의-활용">
<span class="header-section-number">16.2.4</span> IID, ICAR, Lerouzx 랜덤 효과: INLA 패키지의 활용</h3>
<p>Bivand, Gómez-Rubio, and Rue (2015) 및 Gómez-Rubio (2020)는 <strong>INLA</strong> 패키지(Rue, Lindgren, and Teixeira Krainski 2022)와 공간 회귀 모델에 대한 <code>inla</code> 모델 적합 함수의 사용을 설명한다.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>세부적인 차이는 있지만, 고정 모델 공식을 무구조 랜덤 효과 항으로 업데이트하는 접근 방식은 위에서 본 것과 매우 유사하다.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">INLA_iid</span> <span class="op">&lt;-</span> <span class="fu">inla</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu">f</span><span class="op">(</span><span class="va">NOX_ID</span>, model <span class="op">=</span> <span class="st">"iid"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 family <span class="op">=</span> <span class="st">"gaussian"</span>, data <span class="op">=</span> <span class="va">boston_487</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_93</span><span class="op">$</span><span class="va">INLA_re</span> <span class="op">&lt;-</span> <span class="va">INLA_iid</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">$</span><span class="va">mean</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>대부분의 구현과 마찬가지로, 공간 가중치와 인덱싱 변수를 일치시키는 데 주의가 필요하다. 여기서는 <code>NOX_ID</code> 변수를 직접적으로 사용하는 대신, 1부터 93까지의 인덱스를 사용하는 방식을 취한다.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ID2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">boston_487</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>동일한 희소 이진 공간 가중치 행렬이 사용되며, 내재적 CAR 표현은 내부적으로 생성된다.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">INLA_ss</span> <span class="op">&lt;-</span> <span class="fu">inla</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu">f</span><span class="op">(</span><span class="va">ID2</span>, model <span class="op">=</span> <span class="st">"besag"</span>,</span>
<span>                                       graph <span class="op">=</span> <span class="va">W</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                family <span class="op">=</span> <span class="st">"gaussian"</span>, data <span class="op">=</span> <span class="va">boston_487</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_93</span><span class="op">$</span><span class="va">INLA_ss</span> <span class="op">&lt;-</span> <span class="va">INLA_ss</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">ID2</span><span class="op">$</span><span class="va">mean</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Gómez-Rubio (2020)에 의해 제공된 희소 Leroux 표현은 다음과 같이 구성될 수 있다:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html">Diagonal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html">rowSums</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="va">W</span></span>
<span><span class="va">Cmatrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html">Diagonal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">-</span>  <span class="va">M</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>이 모델은 지정된 정밀 행렬과 함께 <code>"generic1"</code> 모델을 사용하여 추정할 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">INLA_lr</span> <span class="op">&lt;-</span> <span class="fu">inla</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu">f</span><span class="op">(</span><span class="va">ID2</span>, model <span class="op">=</span> <span class="st">"generic1"</span>,</span>
<span>                                       Cmatrix <span class="op">=</span> <span class="va">Cmatrix</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                family <span class="op">=</span> <span class="st">"gaussian"</span>, data <span class="op">=</span> <span class="va">boston_487</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_93</span><span class="op">$</span><span class="va">INLA_lr</span> <span class="op">&lt;-</span> <span class="va">INLA_lr</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">ID2</span><span class="op">$</span><span class="va">mean</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="icar-랜덤-효과-mgcv-패키지의-gam-함수의-활용" class="level3" data-number="16.2.5"><h3 data-number="16.2.5" class="anchored" data-anchor-id="icar-랜덤-효과-mgcv-패키지의-gam-함수의-활용">
<span class="header-section-number">16.2.5</span> ICAR 랜덤 효과: mgcv 패키지의 <code>gam()</code> 함수의 활용</h3>
<p>비슷한 방식으로, <strong>mgcv</strong> 패키지의 <code>gam</code> 함수(Wood 2022)는 <code>"nb"</code> 객체를 사용하여 <code>"mrf"</code> 항을 포함할 수 있다. 이 경우, <code>"nb"</code> 객체는 <code>"region.id"</code> 속성의 내용을 이웃 목록 구성 요소의 이름으로 복사해야 하며, 인덱싱 변수는 범주형이어야 한다(Wood 2017).</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">nb_q_93</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">nb_q_93</span>, <span class="st">"region.id"</span><span class="op">)</span></span>
<span><span class="va">boston_487</span><span class="op">$</span><span class="va">NOX_ID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">boston_487</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>공간적으로 구조화된 항의 지정 방식은 위의 예들과 다소 차이가 있지만, 결과는 동일하다. <code>bayesx</code>의 <code>"REML"</code> 방법은 이 경우 <code>gam</code>의 <code>"REML"</code>을 사용하는 것과 동일한 결과를 산출한다.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GAM_MRF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">NOX_ID</span>, bs <span class="op">=</span> <span class="st">"mrf"</span>,</span>
<span>                                      xt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nb <span class="op">=</span> <span class="va">nb_q_93</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               data <span class="op">=</span> <span class="va">boston_487</span>, method <span class="op">=</span> <span class="st">"REML"</span><span class="op">)</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>상위 수준의 랜덤 효과는 예측을 통해 추출할 수 있다. 동일한 상위 수준의 공기 질 모델 출력 구역에 속하는 모든 하위 수준 트랙트의 값은 동일하다는 것을 확인할 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ssre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">GAM_MRF</span>, type <span class="op">=</span> <span class="st">"terms"</span>, </span>
<span>                se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span>, <span class="st">"s(NOX_ID)"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">ssre</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">boston_487</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span>, <span class="va">c</span><span class="op">)</span>,</span>
<span>           <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>따라서 각 상위 수준 단위에 대해 첫 번째 값을 반환할 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">boston_93</span><span class="op">$</span><span class="va">GAM_ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">ssre</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">boston_487</span><span class="op">$</span><span class="va">NOX_ID</span><span class="op">)</span>, </span>
<span>                              <span class="va">head</span>, n<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">x</span></span></code><button title="클립보드 복사" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="상위-수준-랜덤-효과-요약" class="level3" data-number="16.2.6"><h3 data-number="16.2.6" class="anchored" data-anchor-id="상위-수준-랜덤-효과-요약">
<span class="header-section-number">16.2.6</span> 상위-수준 랜덤 효과: 요약</h3>
<p><code>hglm</code>, <code>bayesx</code>, <code>inla</code>, 그리고 <code>gam</code>의 경우, 이산적 반응 변수를 모델링하는 것 역시 가능하다. <code>bayesx,</code> <code>inla</code>, <code>gam</code>의 경우는 해당 공변량에 대한 기능 형태 적합의 일반화를 용이하게 한다.</p>
<p>안타깝게도 이 다수준 모델들이 추정한 공기 질 변수의 회귀계수는 별로 도움이 되지 않는다. 모두 음의 값을 보인 것은 예상대로이지만, 모델 출력 구역 수준 효과와, IID 또는 공간적으로 구조화된 효과가 포함되면서 관찰 스케일의 영향을 해당 스케일(상위 스케일)에서의 공변수의 영향으로부터 분리해 내는 것이 어렵게 되었다.</p>
<p>Figure 16.1은 공기 질 모델 출력 구역 수준의 IID 랜덤 효과가 네 가지 모델 적합 함수 모두에서 매우 유사하다는 것을 보여준다. 모든 지도에서 중앙 도심 구역은 강한 음의 랜덤 효과 값을 보인다. 그런데 중앙 도심 근방에서는 강한 양의 값이 나타나고, 교외 지역은 제로에 가까운 값이 나타난다.</p>
<div id="fig-16-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-16-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="https://r-spatial.org/book/16-SpatialRegression_files/figure-html/fig-multi-levelmaps1-1.png" class="lightbox" data-glightbox="description: .lightbox-desc-1" data-gallery="quarto-lightbox-gallery-1"><img src="https://r-spatial.org/book/16-SpatialRegression_files/figure-html/fig-multi-levelmaps1-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-16-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
그림&nbsp;16.1: 공기 질 모델 출력 구역 수준의 IID 랜덤 효과(<strong>lme4</strong>, <strong>hglm</strong>, <strong>INLA</strong> 및 <strong>R2BayesX</strong>를 사용하여 추정). 응답(<code>log(median)</code>)의 범위는 2.1893이다.
</figcaption></figure>
</div>
<p>Figure 16.2는 공간적으로 구조화된 랜덤 효과가 서로 매우 유사하며, “SAR” 공간적 평활도가 랜덤 효과 항이 취하는 값의 범위를 고려할 때 “CAR” 평활도보다 약간 더 부드럽다는 것을 보여준다.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="https://r-spatial.org/book/16-SpatialRegression_files/figure-html/fig-multi-levelmaps2-1.png" class="lightbox" data-glightbox="description: .lightbox-desc-2" data-gallery="quarto-lightbox-gallery-2" title="공기 질 모델 출력 구역 수준의 공간적으로 구조화된 랜덤 효과(lme4, hglm, INLA, R2BayesX 및 mgcv를 사용하여 추정)."><img src="https://r-spatial.org/book/16-SpatialRegression_files/figure-html/fig-multi-levelmaps2-1.png" class="img-fluid figure-img" alt="공기 질 모델 출력 구역 수준의 공간적으로 구조화된 랜덤 효과(lme4, hglm, INLA, R2BayesX 및 mgcv를 사용하여 추정)."></a></p>
<figcaption>공기 질 모델 출력 구역 수준의 공간적으로 구조화된 랜덤 효과(<strong>lme4</strong>, <strong>hglm</strong>, <strong>INLA</strong>, <strong>R2BayesX</strong> 및 <strong>mgcv</strong>를 사용하여 추정).</figcaption></figure>
</div>
<p>다수준 데이터를 다룰 수 있는 공간 회귀 모델 적합 함수에 대한 보다 철저한 비교 연구가 여전히 필요하지만, 최근 몇 년간 상당한 진전이 있었다. Vranckx, Neyens, and Faes (2019) 질병 매핑 공간 회귀에 대한 비교 연구를 진행했는데, 주로 기대 빈도를 오프셋으로 설정한 포아송 회귀 프레임워크에 초점을 맞춘 것이다. Bivand and Gómez-Rubio (2021)는 공간 가중치 행렬을 사용하여 공간 생존 모델을 추정하는 방법과 공간 프로빗 모델 간의 비교를 다룬다.</p>
</section></section><section id="연습문제" class="level2" data-number="16.3"><h2 data-number="16.3" class="anchored" data-anchor-id="연습문제">
<span class="header-section-number">16.3</span> 연습문제</h2>
<ol type="1">
<li><p><strong>HSAR</strong> 패키지(<a href="https://cran.r-project.org/src/contrib/Archive/HSAR/HSAR_0.5.1.tar.gz" class="uri">https://cran.r-project.org/src/contrib/Archive/HSAR/HSAR_0.5.1.tar.gz</a>)의 아테네 주택 데이터(<strong>spData</strong> 패키지 2.2.1 버전에 포함되어 있음)를 이용하여 다수준 데이터셋을 생성하라. 각 자치구 부서의 속성 값이 각 자치구 부서 내에 위치한 모든 포인트 관측 값에 복사되는 시점은 언제인가?</p></li>
<li><p>상위 수준과 하위 수준 모두에서 이웃 객체를 생성하고, 상위 수준과 하위 수준 모두에서 <code>greensp</code>의 공간적 자기상관을 테스트하라. 자치구 부서의 녹지 면적(제곱 미터)을 포인트 서포트를 가지는 부동산 수준으로 복사한 것의 주요 결과는 무엇인가?</p></li>
<li><p>위의 공식 객체를 사용하여 상위 수준의 변수를 추가하는 것이 합리적인지 평가하라. <strong>mgcv</strong> 패키지의 <code>gam</code> 함수를 사용하여 선형 혼합 효과 모델을 적합하라(자치구 부서에 대한 식별 변수인 <code>num_dep</code>를 사용하여 IID 지정). 하위 수준 변수만 사용한 모델과 하위 및 상위 수준 변수를 모두 사용한 모델을 비교하라. 결론이 달라지는가?</p></li>
<li><p>IID 랜덤 효과를 <code>"mrf"</code> 마르코프 랜덤 필드와 위에서 생성한 연접 이웃 객체로 대체함으로써 분석을 완수하시오. 자치구 부서 수준 변수, 예를 들어 <code>greensp</code>와 같은 변수에 근거하여 결론을 내는 것이 합리적인지에 대해 견해를 밝히시오.</p></li>
</ol>


<div class="hidden" aria-hidden="true">
<span class="glightbox-desc lightbox-desc-1">그림&nbsp;16.1: 공기 질 모델 출력 구역 수준의 IID 랜덤 효과(<strong>lme4</strong>, <strong>hglm</strong>, <strong>INLA</strong> 및 <strong>R2BayesX</strong>를 사용하여 추정). 응답(<code>log(median)</code>)의 범위는 2.1893이다.</span>
<span class="glightbox-desc lightbox-desc-2">공기 질 모델 출력 구역 수준의 공간적으로 구조화된 랜덤 효과(<strong>lme4</strong>, <strong>hglm</strong>, <strong>INLA</strong>, <strong>R2BayesX</strong> 및 <strong>mgcv</strong>를 사용하여 추정).</span>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "복사완료!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "복사완료!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./15.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">공간적 자기상관 측도</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./17.html" class="pagination-link" aria-label="<span class='chapter-number'>17</span>&nbsp; <span class='chapter-title'>공간계량경제학적 모델</span>">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">공간계량경제학적 모델</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/sangillee66/book_sds_trans/issues/new" class="toc-action"><i class="bi bi-github"></i>이슈 보고</a></li></ul></div></div></div></footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","selector":".lightbox","openEffect":"zoom","descPosition":"bottom","loop":false});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>


</body></html>